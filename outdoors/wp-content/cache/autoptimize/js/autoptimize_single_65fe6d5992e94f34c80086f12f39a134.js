function loadConversations(){var clientId=localStorage.getItem('wpaicg_chat_client_id');if(!clientId){clientId=generateRandomString(10);localStorage.setItem('wpaicg_chat_client_id',clientId);}
loadChatInterface('.wpaicg-chat-shortcode','shortcode',clientId);loadChatInterface('.wpaicg-chatbox','widget',clientId);var containers=document.querySelectorAll('.wpaicg-chat-shortcode, .wpaicg-chatbox');containers.forEach(container=>{let botId=container.getAttribute('data-bot-id')||'0';let chatType=container.getAttribute('data-type')||'shortcode';let conversationKeyBase=(botId!=='0')?`wpaicg_chat_history_custom_bot_${botId}_${clientId}`:`wpaicg_chat_history_${chatType}_${clientId}`;let highestIndex=0;for(let i=0;i<localStorage.length;i++){let key=localStorage.key(i);if(key.startsWith(conversationKeyBase)){let suffixMatch=key.match(/_(\d+)$/);if(suffixMatch){let indexNum=parseInt(suffixMatch[1],10);if(indexNum>highestIndex){highestIndex=indexNum;}}}}
if(highestIndex===0){highestIndex=1;let firstConversationKey=`${conversationKeyBase}_${highestIndex}`;localStorage.setItem(firstConversationKey,JSON.stringify([]));}
let latestConversationKey=`${conversationKeyBase}_${highestIndex}`;let activeConversationKey=`wpaicg_current_conversation_${botId}_${clientId}`;localStorage.setItem(activeConversationKey,latestConversationKey);let assistantEnabled=container.getAttribute('data-assistant-enabled')==='true';if(assistantEnabled){let threadBase=(botId!=='0')?`custom_bot_${botId}_${clientId}`:`${chatType}_${clientId}`;let threadListObj=JSON.parse(localStorage.getItem('wpaicg_thread_list'))||{};let highestThreadIndex=0;for(let existingKey in threadListObj){if(existingKey.startsWith(threadBase)){let suffixMatch=existingKey.match(/_(\d+)$/);if(suffixMatch){let threadIndexNum=parseInt(suffixMatch[1],10);if(threadIndexNum>highestThreadIndex){highestThreadIndex=threadIndexNum;}}}}
if(highestThreadIndex===0){highestThreadIndex=1;let newThreadKey=`${threadBase}_${highestThreadIndex}`;localStorage.setItem(`wpaicg_current_thread_${botId}_${clientId}`,newThreadKey);}else{let existingThreadKey=`${threadBase}_${highestThreadIndex}`;localStorage.setItem(`wpaicg_current_thread_${botId}_${clientId}`,existingThreadKey);}}});loadConversationList();}
function initNewChatButtons(){const newChatButtons=document.querySelectorAll('.wpaicg-new-chat-button');newChatButtons.forEach(button=>{button.addEventListener('click',function(){const chatContainer=button.closest('.wpaicg-chat-shortcode, .wpaicg-chatbox');if(!chatContainer)return;const botId=chatContainer.getAttribute('data-bot-id')||'0';const chatType=chatContainer.getAttribute('data-type')||'shortcode';const assistantEnabled=chatContainer.getAttribute('data-assistant-enabled')==='true';let conversationKeyBase='';if(botId!=='0'){conversationKeyBase=`wpaicg_chat_history_custom_bot_${botId}`;}else{conversationKeyBase=`wpaicg_chat_history_${chatType}`;}
let clientID=localStorage.getItem('wpaicg_chat_client_id');if(!clientID){clientID=generateRandomString(10);localStorage.setItem('wpaicg_chat_client_id',clientID);}
conversationKeyBase+=`_${clientID}`;let highestIndex=0;for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key.startsWith(conversationKeyBase)){const suffixMatch=key.match(/_(\d+)$/);if(suffixMatch){const indexNum=parseInt(suffixMatch[1],10);if(indexNum>highestIndex)highestIndex=indexNum;}}}
const newConversationIndex=highestIndex+1;const newConversationKey=`${conversationKeyBase}_${newConversationIndex}`;localStorage.setItem(newConversationKey,JSON.stringify([]));localStorage.setItem(`${newConversationKey}_timestamp`,Date.now().toString());const activeConversationKey=`wpaicg_current_conversation_${botId}_${clientID}`;localStorage.setItem(activeConversationKey,newConversationKey);if(assistantEnabled){const threadBase=botId!=='0'?`custom_bot_${botId}_${clientID}`:`${chatType}_${clientID}`;let highestThreadIndex=0;const threadListObj=JSON.parse(localStorage.getItem('wpaicg_thread_list'))||{};for(let existingKey in threadListObj){if(existingKey.startsWith(threadBase)){const suffixMatch=existingKey.match(/_(\d+)$/);if(suffixMatch){const threadIndexNum=parseInt(suffixMatch[1],10);if(threadIndexNum>highestThreadIndex)highestThreadIndex=threadIndexNum;}}}
const newThreadIndex=highestThreadIndex+1;const newThreadKey=`${threadBase}_${newThreadIndex}`;const activeThreadKey=`wpaicg_current_thread_${botId}_${clientID}`;localStorage.setItem(activeThreadKey,newThreadKey);}
loadSelectedConversation(newConversationKey,chatContainer);loadConversationList();});});}
function generateRandomString(length){let result='';const characters='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';for(let i=0;i<length;i++){result+=characters.charAt(Math.floor(Math.random()*characters.length));}
return result;}
function showAllConversationStarters(){var containers=['.wpaicg-chat-shortcode','.wpaicg-chatbox'];containers.forEach(containerSelector=>{var chatContainers=document.querySelectorAll(containerSelector);chatContainers.forEach(chatContainer=>{showConversationStarters(chatContainer);});});}
function updateChatHistory(message,sender,uniqueId,chat,chatbot_identity,clientID){const botId=chat.getAttribute('data-bot-id')||'0';const activeConversationKey=`wpaicg_current_conversation_${botId}_${clientID}`;let conversationKey=localStorage.getItem(activeConversationKey);if(!conversationKey){let defaultIndex=1;if(botId!=='0'){conversationKey=`wpaicg_chat_history_custom_bot_${botId}_${clientID}_${defaultIndex}`;}else{const type=chat.getAttribute('data-type')||'shortcode';conversationKey=`wpaicg_chat_history_${type}_${clientID}_${defaultIndex}`;}
localStorage.setItem(conversationKey,JSON.stringify([]));localStorage.setItem(activeConversationKey,conversationKey);}
let history=JSON.parse(localStorage.getItem(conversationKey)||'[]');const memoryLimit=parseInt(chat.getAttribute('data-memory-limit'),10)||100;const formattedMessage=(sender==='user'?"Human: ":"AI: ")+(message.trim()||'');const numericId=typeof uniqueId==='string'?parseInt(uniqueId,10):uniqueId;history.push({id:numericId||'',text:formattedMessage});if(history.length>memoryLimit){history=history.slice(-memoryLimit);}
localStorage.setItem(conversationKey,JSON.stringify(history));localStorage.setItem(`${conversationKey}_timestamp`,Date.now().toString());loadConversationList();}
function loadChatInterface(containerSelector,type,clientId){var chatContainers=document.querySelectorAll(containerSelector);chatContainers.forEach(chatContainer=>{var autoloadConversations=chatContainer.getAttribute('data-autoload_chat_conversations');if(autoloadConversations===null){autoloadConversations='1';}
var botId=chatContainer.getAttribute('data-bot-id')||'0';if(autoloadConversations==='0'){var activeConversationKey=`wpaicg_current_conversation_${botId}_${clientId}`;var conversationKey=localStorage.getItem(activeConversationKey);if(!conversationKey){let highestIndex=0;let conversationKeyBase=botId!=='0'?`wpaicg_chat_history_custom_bot_${botId}_${clientId}`:`wpaicg_chat_history_${type}_${clientId}`;for(let i=0;i<localStorage.length;i++){let key=localStorage.key(i);if(key.startsWith(conversationKeyBase)){let suffixMatch=key.match(/_(\d+)$/);if(suffixMatch){let indexNum=parseInt(suffixMatch[1],10);if(indexNum>highestIndex){highestIndex=indexNum;}}}}
if(highestIndex>0){conversationKey=`${conversationKeyBase}_${highestIndex}`;}}
if(conversationKey&&localStorage.getItem(conversationKey)){var chatHistory=localStorage.getItem(conversationKey);chatHistory=JSON.parse(chatHistory);chatHistory=chatHistory.map(message=>{if(typeof message==='string'){return{id:'',text:message};}
return message;});localStorage.setItem(conversationKey,JSON.stringify(chatHistory));var chatBox=chatContainer.querySelector('.wpaicg-chatbox-messages, .wpaicg-chat-shortcode-messages');if(!chatBox){console.error(`No chat box found within the ${type} container.`);return;}
chatBox.innerHTML='';chatHistory.forEach(message=>{reconstructMessage(chatBox,message,chatContainer);});chatBox.appendChild(document.createElement('br'));requestAnimationFrame(()=>{requestAnimationFrame(()=>{chatBox.scrollTop=chatBox.scrollHeight;});});hideConversationStarter(chatContainer);}else{showConversationStarters(chatContainer);}}else{showConversationStarters(chatContainer);}});}
function reconstructMessage(chatBox,message,chatContainer){var messageElement=document.createElement('li');var messageText=typeof message==='object'&&message.text?message.text:message;var isUserMessage=messageText.startsWith('Human:');var isWidget=chatContainer.classList.contains('wpaicg-chatbox');if(isUserMessage){messageElement.className=isWidget?'wpaicg-chat-user-message':'wpaicg-user-message';}else{messageElement.className=isWidget?'wpaicg-chat-ai-message':'wpaicg-ai-message';}
var formattedMessage=messageText.replace('Human:','').replace('AI:','');formattedMessage=marked.parse(formattedMessage);var userBgColor=chatContainer.getAttribute('data-user-bg-color');var aiBgColor=chatContainer.getAttribute('data-ai-bg-color');var fontSize=chatContainer.getAttribute('data-fontsize');var fontColor=chatContainer.getAttribute('data-color');messageElement.style.backgroundColor=isUserMessage?userBgColor:aiBgColor;messageElement.style.color=fontColor;messageElement.style.fontSize=fontSize;messageElement.innerHTML=`<span class="wpaicg-chat-message">${formattedMessage}</span>`;chatBox.appendChild(messageElement);}
function hideConversationStarter(chatContainer){var starters=chatContainer.querySelectorAll('.wpaicg-conversation-starters');starters.forEach(starter=>starter.style.display='none');}
function showConversationStarters(chatContainer){const startersContainer=chatContainer.querySelector('.wpaicg-conversation-starters');if(startersContainer){startersContainer.style.visibility='visible';const starters=startersContainer.querySelectorAll('.wpaicg-conversation-starter');starters.forEach((starter,index)=>{setTimeout(()=>{starter.style.opacity="1";starter.style.transform="translateY(0)";},index*150);});}}
function wpaicgChatShortcodeSize(){var wpaicgWindowWidth=window.innerWidth;var wpaicgWindowHeight=window.innerHeight;var chatShortcodes=document.getElementsByClassName('wpaicg-chat-shortcode');if(chatShortcodes!==null&&chatShortcodes.length){for(var i=0;i<chatShortcodes.length;i++){var chatShortcode=chatShortcodes[i];var parentChat=chatShortcode.parentElement;var parentWidth=parentChat.offsetWidth;var chatWidth=chatShortcode.getAttribute('data-width');var chatHeight=chatShortcode.getAttribute('data-height');var chatFooter=chatShortcode.getAttribute('data-footer')==='true';var chatBar=chatShortcode.getAttribute('data-has-bar')==='true';var chatRounded=parseFloat(chatShortcode.getAttribute('data-chat_rounded'));var textRounded=parseFloat(chatShortcode.getAttribute('data-text_rounded'));var textHeight=parseFloat(chatShortcode.getAttribute('data-text_height'));var textInput=chatShortcode.getElementsByClassName('wpaicg-chat-shortcode-typing')[0];textInput.style.height=textHeight+'px';textInput.style.borderRadius=textRounded+'px';chatShortcode.style.borderRadius=chatRounded+'px';chatShortcode.style.overflow='hidden';chatWidth=chatWidth!==null?chatWidth:'350';chatHeight=chatHeight!==null?chatHeight:'400';if(chatShortcode.classList.contains('wpaicg-fullscreened')){parentWidth=wpaicgWindowWidth;if(wpaicgWindowWidth<480){chatWidth=wpaicgWindowWidth;chatHeight=wpaicgWindowHeight-40;}else{chatWidth=resolveDimension(chatWidth,parentWidth);chatHeight=resolveDimension(chatHeight,wpaicgWindowHeight);}
chatShortcode.style.width=chatWidth+'px';chatShortcode.style.maxWidth=chatWidth+'px';chatShortcode.style.height=chatHeight+'px';chatShortcode.style.maxHeight=chatHeight+'px';chatShortcode.style.marginTop=0;var deduceHeight=69;if(chatFooter){deduceHeight+=60;}
if(chatBar){deduceHeight+=30;}
deduceHeight+=20;if(wpaicgWindowWidth<480){deduceHeight+=20;}
if(!chatFooter&&wpaicgWindowWidth<480){deduceHeight+=60;}
var chatMessages=chatShortcode.getElementsByClassName('wpaicg-chat-shortcode-messages')[0];chatMessages.style.height=(chatHeight-deduceHeight-textHeight)+'px';requestAnimationFrame(()=>{requestAnimationFrame(()=>{chatMessages.scrollTop=chatMessages.scrollHeight;});});}
else{if(chatWidth.indexOf('%')<0){if(chatWidth.indexOf('px')<0){chatWidth=parseFloat(chatWidth);}else{chatWidth=parseFloat(chatWidth.replace(/px/g,''));}}else{chatWidth=parseFloat(chatWidth.replace(/%/g,''));if(chatWidth<100){chatWidth=chatWidth*parentWidth/100;}else{chatWidth='';}}
if(chatHeight.indexOf('%')<0){if(chatHeight.indexOf('px')<0){chatHeight=parseFloat(chatHeight);}else{chatHeight=parseFloat(chatHeight.replace(/px/g,''));}}else{chatHeight=parseFloat(chatHeight.replace(/%/g,''));chatHeight=chatHeight*wpaicgWindowHeight/100;}
if(chatWidth!==''){chatShortcode.style.width=chatWidth+'px';chatShortcode.style.maxWidth=chatWidth+'px';}else{chatShortcode.style.width='';chatShortcode.style.maxWidth='';}
if(chatShortcode.classList.contains('wpaicg-fullscreened')){chatShortcode.style.marginTop=0;}else{chatShortcode.style.marginTop='';}
var chatMessages=chatShortcode.getElementsByClassName('wpaicg-chat-shortcode-messages')[0];var deduceHeight=69;if(chatFooter){deduceHeight+=60;}
if(chatBar){deduceHeight+=30;}
deduceHeight+=20;if(wpaicgWindowWidth<480){deduceHeight+=20;}
if(!chatFooter&&wpaicgWindowWidth<480){deduceHeight+=60;}
chatMessages.style.height=(chatHeight-deduceHeight-textHeight)+'px';}}}}
function wpaicgChatBoxSize(){var wpaicgWindowWidth=window.innerWidth;var wpaicgWindowHeight=window.innerHeight;var chatWidgets=document.getElementsByClassName('wpaicg_chat_widget_content');var isMobile=wpaicgWindowWidth<=767;if(chatWidgets.length){for(var i=0;i<chatWidgets.length;i++){var chatWidget=chatWidgets[i];var chatbox=chatWidget.getElementsByClassName('wpaicg-chatbox')[0];if(!chatbox)continue;var chatWidth=chatbox.getAttribute('data-width')||'350';var chatHeight=chatbox.getAttribute('data-height')||'400';var chatFooter=chatbox.getAttribute('data-footer')==='true';var chatboxBar=chatbox.getElementsByClassName('wpaicg-chatbox-action-bar');var textHeight=parseFloat(chatbox.getAttribute('data-text_height'));if(chatWidget.classList.contains('wpaicg-fullscreened')||isMobile){chatWidth=wpaicgWindowWidth;chatHeight=wpaicgWindowHeight-(isMobile?60:20);if(isMobile){chatWidget.style.position='fixed';chatWidget.style.top='0';chatWidget.style.left='0';chatWidget.style.right='0';chatWidget.style.bottom='0';chatWidget.style.zIndex='999999';chatWidget.style.width='100%';chatWidget.style.height='100%';chatWidget.style.maxWidth='none';chatWidget.style.maxHeight='none';}}else{chatWidth=resolveDimension(chatWidth,wpaicgWindowWidth);chatHeight=resolveDimension(chatHeight,wpaicgWindowHeight);}
chatbox.style.width=chatWidth+'px';chatbox.style.height=chatHeight+'px';chatWidget.style.width=chatWidth+'px';chatWidget.style.height=chatHeight+'px';var actionBarHeight=chatboxBar.length?40:0;var footerHeight=chatFooter?60:0;var extraGap=(isMobile)?40:20;if(!chatFooter&&isMobile){footerHeight=60;}
var contentHeight=chatHeight-textHeight-actionBarHeight-footerHeight-extraGap;var messagesHeight=contentHeight-20;var chatboxContent=chatWidget.getElementsByClassName('wpaicg-chatbox-content')[0];var chatboxMessages=chatWidget.getElementsByClassName('wpaicg-chatbox-messages')[0];chatboxContent.style.height=contentHeight+'px';chatboxMessages.style.height=messagesHeight+'px';chatboxMessages.scrollTop=chatboxMessages.scrollHeight;}}}
function resolveDimension(value,totalSize){if(value.includes('%')){return parseFloat(value)/100*totalSize;}else if(value.includes('px')){return parseFloat(value.replace('px',''));}
return parseFloat(value);}
function wpaicgChatInit(){let wpaicgMicIcon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><path d="M176 0C123 0 80 43 80 96V256c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM48 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H104c-13.3 0-24 10.7-24 24s10.7 24 24 24h72 72c13.3 0 24-10.7 24-24s-10.7-24-24-24H200V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z"/></svg>';let wpaicgStopIcon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm256-96a96 96 0 1 1 0 192 96 96 0 1 1 0-192zm0 224a128 128 0 1 0 0-256 128 128 0 1 0 0 256zm0-96a32 32 0 1 0 0-64 32 32 0 1 0 0 64z"/></svg>';var wpaicgChatStream;var wpaicgChatRec;var wpaicgInput;var wpaicgChatAudioContext=window.AudioContext||window['webkitAudioContext'];var wpaicgaudioContext;var wpaicgMicBtns=document.querySelectorAll('.wpaicg-mic-icon');var wpaicgChatTyping=document.querySelectorAll('.wpaicg-chatbox-typing');var wpaicgShortcodeTyping=document.querySelectorAll('.wpaicg-chat-shortcode-typing');var wpaicgChatSend=document.querySelectorAll('.wpaicg-chatbox-send');var wpaicgShortcodeSend=document.querySelectorAll('.wpaicg-chat-shortcode-send');var wpaicgChatFullScreens=document.getElementsByClassName('wpaicg-chatbox-fullscreen');var wpaicgChatCloseButtons=document.getElementsByClassName('wpaicg-chatbox-close-btn');var wpaicgChatDownloadButtons=document.getElementsByClassName('wpaicg-chatbox-download-btn');var wpaicg_chat_widget_toggles=document.getElementsByClassName('wpaicg_toggle');var wpaicg_chat_widgets=document.getElementsByClassName('wpaicg_chat_widget');var imageInputThumbnail=null;function setupConversationStarters(){const starters=document.querySelectorAll('.wpaicg-conversation-starter');starters.forEach(starter=>{starter.addEventListener('click',function(){const messageText=starter.innerText||starter.textContent;const chatContainer=starter.closest('.wpaicg-chat-shortcode')||starter.closest('.wpaicg-chatbox');const type=chatContainer.classList.contains('wpaicg-chat-shortcode')?'shortcode':'widget';const typingInput=type==='shortcode'?chatContainer.querySelector('.wpaicg-chat-shortcode-typing'):chatContainer.querySelector('.wpaicg-chatbox-typing');typingInput.value=messageText;wpaicgSendChatMessage(chatContainer,typingInput,type);starters.forEach(starter=>{starter.style.display='none';});});});}
function maybeShowLeadForm(chat,chatId){function isTruthy(value){if(value===null||value===undefined)return false;return value==='1'||value.toLowerCase()==='true';}
let leadCollectionEnabled=isTruthy(chat.getAttribute('data-lead-collection'));if(!leadCollectionEnabled){return;}
let leadFormShown=localStorage.getItem('wpaicg_lead_form_shown');if(leadFormShown==='1'){return;}
let enableLeadName=isTruthy(chat.getAttribute('data-enable-lead-name'));let enableLeadEmail=isTruthy(chat.getAttribute('data-enable-lead-email'));let enableLeadPhone=isTruthy(chat.getAttribute('data-enable-lead-phone'));if(!(enableLeadName||enableLeadEmail||enableLeadPhone)){return;}
let leadTitle=chat.getAttribute('data-lead-title')||'Contact Information';let leadNameLabel=chat.getAttribute('data-lead-name')||'Name';let leadEmailLabel=chat.getAttribute('data-lead-email')||'Email';let leadPhoneLabel=chat.getAttribute('data-lead-phone')||'Phone';let wpaicg_nonce=chat.getAttribute('data-nonce');let aiBg=chat.getAttribute('data-ai-bg-color');let fontSize=chat.getAttribute('data-fontsize');let fontColor=chat.getAttribute('data-color');let text_field_bgcolor=chat.getAttribute('data-bg_text_field');let text_field_font_color=chat.getAttribute('data-bg_text_field_font_color');let text_field_border_color=chat.getAttribute('data-bg_text_field_border_color');let formHtml=`
        <li class="wpaicg-lead-form-message" style="background-color:${aiBg};font-size:${fontSize}px;color:${fontColor}">
            <div class="wpaicg-lead-form-container">
                <button class="wpaicg-lead-form-close" style="float:right;">&times;</button>
                <h2>${leadTitle}</h2>
                <form>
        `;if(enableLeadName){formHtml+=`
                <div class="wpaicg-lead-form-field">
                    <label>${leadNameLabel}</label>
                    <input type="text" name="lead_name"/>
                </div>
            `;}
if(enableLeadEmail){formHtml+=`
                <div class="wpaicg-lead-form-field">
                    <label>${leadEmailLabel}</label>
                    <input type="email" name="lead_email" />
                </div>
            `;}
if(enableLeadPhone){formHtml+=`
                <div class="wpaicg-lead-form-field">
                    <label>${leadPhoneLabel}</label>
                    <input type="tel" name="lead_phone"/>
                </div>
            `;}
formHtml+=`
                <div class="wpaicg-lead-form-error" style="color: red; display: none;"></div>
        `;formHtml+=`
                    <div class="svg-submit-button-container">
                        <button type="submit" class="svg-submit-button">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill=${fontColor} aria-hidden="true" width="24" height="24"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z"></path></svg>
                        </button>
                    </div>
                </form>
            </div>
        </li>
        `;let messagesList=chat.querySelector('.wpaicg-chatbox-messages')||chat.querySelector('.wpaicg-chat-shortcode-messages');if(messagesList){messagesList.insertAdjacentHTML('beforeend',formHtml);}
let styles=`
        .wpaicg-lead-form-message {
            list-style: none;
            padding: 10px;
            margin-bottom: 10px;
            position: relative;
        }
    
        .wpaicg-lead-form-container {
            display: block;
        }
    
        .wpaicg-lead-form-container h2 {
            margin-top: 0;
            font-size: 1.2em;
            margin-bottom: 10px;
            color: ${fontColor};
            padding-right: 40px;
        }
    
        .wpaicg-lead-form-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: ${fontColor};
        }
    
        .wpaicg-lead-form-field {
            margin-bottom: 15px;
        }
    
        .wpaicg-lead-form-field label {
            display: block;
            margin-bottom: 5px;
        }
    
        .wpaicg-lead-form-field input {
            color: ${text_field_font_color};
            background-color: ${text_field_bgcolor};
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid ${text_field_border_color};
        }
    
        .svg-submit-button {
            background-color: ${aiBg};
            border: none;
            cursor: pointer;
            padding: 10px;
            outline: none;
        }

        .svg-submit-button svg {
            fill: ${fontColor}; /* Dynamic color */
            transition: fill 0.3s ease;
        }

        /* Spinner inside button */
        .wpaicg-lead-spinner {
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }

        .wpaicg-lead-spinner .dot {
            font-size: 16px;
            color: ${fontColor};
            animation: jump 1s infinite;
            margin: 0 2px;
        }

        /* Align submit button to the right */
        .svg-submit-button-container {
            text-align: right; /* This aligns the button to the right */
        }

        @keyframes jump {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-6px);
            }
        }

        `;let styleSheet=document.createElement("style");styleSheet.innerText=styles;document.head.appendChild(styleSheet);let formMessage=messagesList.querySelector('.wpaicg-lead-form-message');let closeButton=formMessage.querySelector('.wpaicg-lead-form-close');let form=formMessage.querySelector('form');let errorDiv=form.querySelector('.wpaicg-lead-form-error');closeButton.addEventListener('click',function(){formMessage.remove();localStorage.setItem('wpaicg_lead_form_shown','1');});form.addEventListener('submit',function(event){event.preventDefault();let nameInput=form.querySelector('input[name="lead_name"]');let emailInput=form.querySelector('input[name="lead_email"]');let phoneInput=form.querySelector('input[name="lead_phone"]');let nameValue=nameInput?nameInput.value.trim():'';let emailValue=emailInput?emailInput.value.trim():'';let phoneValue=phoneInput?phoneInput.value.trim():'';if(!nameValue&&!emailValue&&!phoneValue){errorDiv.textContent='Please fill in at least one field.';errorDiv.style.display='block';return;}else{errorDiv.textContent='';errorDiv.style.display='none';}
let submitButton=form.querySelector('.svg-submit-button');submitButton.innerHTML=`
                <div class="wpaicg-lead-spinner">
                    <span class="dot">•</span>
                    <span class="dot">•</span>
                    <span class="dot">•</span>
                </div>
            `;submitButton.disabled=true;let formData=new FormData(form);formData.append('action','wpaicg_submit_lead');formData.append('_wpnonce',wpaicg_nonce);formData.append('chatId',chatId);fetch(wpaicgParams.ajax_url,{method:'POST',body:formData}).then(response=>response.json()).then(data=>{formMessage.remove();localStorage.setItem('wpaicg_lead_form_shown','1');}).catch(error=>{console.error('Error submitting lead form:',error);formMessage.remove();localStorage.setItem('wpaicg_lead_form_shown','1');}).finally(()=>{submitButton.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="${fontColor}" class="bi bi-send" viewBox="0 0 16 16">
                        <path d="M15.5 0.5a.5.5 0 0 0-.854-.353L.646 14.646a.5.5 0 0 0 .708.708L15.5 0.854A.5.5 0 0 0 15.5 0.5z"/>
                        <path d="M6.646 15.646l8-8a.5.5 0 0 0-.708-.708l-8 8a.5.5 0 1 0 .708.708z"/>
                        <path d="M4.5 3.5a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1h-6z"/>
                    </svg>
                `;submitButton.disabled=false;});});}
setupConversationStarters();var wpaicgUserAudioEnabled={};function setupAudioButtons(){var wpaicgAudioButtons=document.querySelectorAll('.wpaicg-chatbox-audio-btn');wpaicgAudioButtons.forEach(button=>{var chatContainer=button.closest('.wpaicg-chat-shortcode, .wpaicg-chatbox');var botId=chatContainer.getAttribute('data-bot-id')||'0';var chatType=chatContainer.getAttribute('data-type')||'shortcode';var audioKey=`audio_${chatType}_${botId}`;var voiceMutedByDefault=chatContainer.getAttribute('data-voice-muted-by-default')==='1';if(voiceMutedByDefault){wpaicgUserAudioEnabled[audioKey]=false;button.classList.remove('wpaicg-audio-enabled');button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3zM425 167l55 55 55-55c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-55 55 55 55c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-55-55-55 55c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l55-55-55-55c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0z"/></svg>';}else{wpaicgUserAudioEnabled[audioKey]=true;button.classList.add('wpaicg-audio-enabled');button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M533.6 32.5C598.5 85.2 640 165.8 640 256s-41.5 170.7-106.4 223.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C557.5 398.2 592 331.2 592 256s-34.5-142.2-88.7-186.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM473.1 107c43.2 35.2 70.9 88.9 70.9 149s-27.7 113.8-70.9 149c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C475.3 341.3 496 301.1 496 256s-20.7-85.3-53.2-111.8c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zm-60.5 74.5C434.1 199.1 448 225.9 448 256s-13.9 56.9-35.4 74.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C393.1 284.4 400 271 400 256s-6.9-28.4-17.7-37.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3z"/></svg>';}
button.addEventListener('click',function(){wpaicgUserAudioEnabled[audioKey]=!wpaicgUserAudioEnabled[audioKey];if(wpaicgUserAudioEnabled[audioKey]){button.classList.add('wpaicg-audio-enabled');button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><path d="M533.6 32.5C598.5 85.2 640 165.8 640 256s-41.5 170.7-106.4 223.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C557.5 398.2 592 331.2 592 256s-34.5-142.2-88.7-186.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM473.1 107c43.2 35.2 70.9 88.9 70.9 149s-27.7 113.8-70.9 149c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C475.3 341.3 496 301.1 496 256s-20.7-85.3-53.2-111.8c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zm-60.5 74.5C434.1 199.1 448 225.9 448 256s-13.9 56.9-35.4 74.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C393.1 284.4 400 271 400 256s-6.9-28.4-17.7-37.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3z"/></svg>';}else{button.classList.remove('wpaicg-audio-enabled');button.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><path d="M301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3zM425 167l55 55 55-55c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-55 55 55 55c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0l-55-55-55 55c-9.4 9.4-24.6 9.4-33.9 0s-9.4-24.6 0-33.9l55-55-55-55c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0z"/></svg>';}});});}
setupAudioButtons();var imageIcon=document.querySelector('.wpaicg-img-icon');var spinner=document.querySelector('.wpaicg-img-spinner');var thumbnailPlaceholder=document.querySelector('.wpaicg-thumbnail-placeholder');if(imageIcon){imageIcon.addEventListener('click',function(){var imageInput=document.getElementById('imageUpload');imageInput.click();});}
var imageInput=document.getElementById('imageUpload');if(imageInput){imageInput.addEventListener('change',function(){if(this.files&&this.files[0]){var file=this.files[0];imageIcon.style.display='none';spinner.style.display='inline-block';imageIcon.title=file.name;setTimeout(function(){spinner.style.display='none';imageIcon.style.display='inline-block';thumbnailPlaceholder.style.backgroundImage=`url(${URL.createObjectURL(file)})`;thumbnailPlaceholder.style.backgroundSize='cover';thumbnailPlaceholder.style.backgroundPosition='center';thumbnailPlaceholder.style.backgroundRepeat='no-repeat';thumbnailPlaceholder.style.display='inline-block';},2000);}});}
function setupClearChatButtons(){var wpaicgChatClearButtons=document.querySelectorAll('.wpaicg-chatbox-clear-btn');wpaicgChatClearButtons.forEach(button=>{button.addEventListener('click',function(){var chatContainer=button.closest('[data-bot-id]');if(chatContainer){var botId=chatContainer.getAttribute('data-bot-id')||'0';var clientId=localStorage.getItem('wpaicg_chat_client_id');clearChatHistory(botId,clientId,chatContainer);}});});}
function clearChatHistory(botId,clientId,chatContainer){var isCustomBot=botId!=='0';var type=chatContainer.classList.contains('wpaicg-chat-shortcode')?'shortcode':'widget';const activeConversationKey=`wpaicg_current_conversation_${botId}_${clientId}`;const currentConversationKey=localStorage.getItem(activeConversationKey);if(currentConversationKey){localStorage.removeItem(currentConversationKey);localStorage.removeItem(`${currentConversationKey}_timestamp`);}else{var historyKey=isCustomBot?`wpaicg_chat_history_custom_bot_${botId}_${clientId}`:`wpaicg_chat_history_${type}_${clientId}`;for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key&&key.startsWith(historyKey)){localStorage.removeItem(key);}}}
var chatBoxSelector='.wpaicg-chatbox-messages, .wpaicg-chat-shortcode-messages';var chatBox=chatContainer.querySelector(chatBoxSelector);if(chatBox){chatBox.innerHTML='';}
localStorage.removeItem('wpaicg_lead_form_shown');var threadList=localStorage.getItem('wpaicg_thread_list');if(threadList){try{var threadListObj=JSON.parse(threadList);var threadKey=isCustomBot?`custom_bot_${botId}_${clientId}`:`${type}_${clientId}`;const activeThreadKey=`wpaicg_current_thread_${botId}_${clientId}`;const currentThreadKey=localStorage.getItem(activeThreadKey);if(currentThreadKey&&threadListObj[currentThreadKey]){delete threadListObj[currentThreadKey];}else{for(let existingKey in threadListObj){if(existingKey.startsWith(threadKey)){delete threadListObj[existingKey];}}}
localStorage.setItem('wpaicg_thread_list',JSON.stringify(threadListObj));}catch(error){console.error('Error parsing wpaicg_thread_list:',error);}}
showConversationStarters(chatContainer);loadConversationList();}
setupClearChatButtons();if(wpaicg_chat_widget_toggles!==null&&wpaicg_chat_widgets.length){for(var i=0;i<wpaicg_chat_widget_toggles.length;i++){var wpaicg_chat_widget_toggle=wpaicg_chat_widget_toggles[i];var wpaicg_chat_widget=wpaicg_chat_widget_toggle.closest('.wpaicg_chat_widget');wpaicg_chat_widget_toggle.addEventListener('click',function(e){e.preventDefault();wpaicg_chat_widget_toggle=e.currentTarget;if(wpaicg_chat_widget_toggle.classList.contains('wpaicg_widget_open')){wpaicg_chat_widget_toggle.classList.remove('wpaicg_widget_open');wpaicg_chat_widget.classList.remove('wpaicg_widget_open');}else{wpaicg_chat_widget.classList.add('wpaicg_widget_open');wpaicg_chat_widget_toggle.classList.add('wpaicg_widget_open');if(window.innerWidth<=767){var widgetContent=wpaicg_chat_widget.querySelector('.wpaicg_chat_widget_content');if(widgetContent&&!widgetContent.classList.contains('wpaicg-fullscreened')){var fullscreenBtn=widgetContent.querySelector('.wpaicg-chatbox-fullscreen');if(fullscreenBtn){wpaicgFullScreen(fullscreenBtn);fullscreenBtn.style.display='none';}}}}});}}
if(wpaicgChatDownloadButtons.length){for(var i=0;i<wpaicgChatDownloadButtons.length;i++){var wpaicgChatDownloadButton=wpaicgChatDownloadButtons[i];wpaicgChatDownloadButton.addEventListener('click',function(e){wpaicgChatDownloadButton=e.currentTarget;var type=wpaicgChatDownloadButton.getAttribute('data-type');var wpaicgWidgetContent,listMessages;if(type==='shortcode'){wpaicgWidgetContent=wpaicgChatDownloadButton.closest('.wpaicg-chat-shortcode');listMessages=wpaicgWidgetContent.getElementsByClassName('wpaicg-chat-shortcode-messages');}
else{wpaicgWidgetContent=wpaicgChatDownloadButton.closest('.wpaicg_chat_widget_content');listMessages=wpaicgWidgetContent.getElementsByClassName('wpaicg-chatbox-messages');}
if(listMessages.length){var listMessage=listMessages[0];var messages=[];var chatMessages=listMessage.getElementsByTagName('li');if(chatMessages.length){for(var i=0;i<chatMessages.length;i++){messages.push(chatMessages[i].innerText.replace("\n",' '));}}
var messagesDownload=messages.join("\n");var element=document.createElement('a');element.setAttribute('href','data:text/plain;charset=utf-8,'+encodeURIComponent(messagesDownload));element.setAttribute('download','chat.txt');element.style.display='none';document.body.appendChild(element);element.click();document.body.removeChild(element);}})}}
if(wpaicgChatCloseButtons.length){for(var i=0;i<wpaicgChatCloseButtons.length;i++){var wpaicgChatCloseButton=wpaicgChatCloseButtons[i];wpaicgChatCloseButton.addEventListener('click',function(e){wpaicgChatCloseButton=e.currentTarget;var wpaicgWidgetContent=wpaicgChatCloseButton.closest('.wpaicg_chat_widget_content');var chatbox=wpaicgWidgetContent.closest('.wpaicg_chat_widget');if(wpaicgWidgetContent.classList.contains('wpaicg-fullscreened')){var fullScreenBtn=wpaicgWidgetContent.getElementsByClassName('wpaicg-chatbox-fullscreen')[0];wpaicgFullScreen(fullScreenBtn);}
chatbox.getElementsByClassName('wpaicg_toggle')[0].click();})}}
function wpaicgFullScreen(btn){const type=btn.getAttribute('data-type');const isExitingFullscreen=btn.classList.contains('wpaicg-fullscreen-box');const isMobile=window.innerWidth<=767;if(type==='shortcode'){const wpaicgChatShortcode=btn.closest('.wpaicg-chat-shortcode');if(!wpaicgChatShortcode)return;if(isExitingFullscreen){btn.classList.remove('wpaicg-fullscreen-box');wpaicgChatShortcode.classList.remove('wpaicg-fullscreened');const oldInlineStyle=wpaicgChatShortcode.getAttribute('data-old-inline-style')||'';wpaicgChatShortcode.setAttribute('style',oldInlineStyle);wpaicgChatShortcode.removeAttribute('data-old-inline-style');const oldDataWidth=wpaicgChatShortcode.getAttribute('data-old-width');const oldDataHeight=wpaicgChatShortcode.getAttribute('data-old-height');if(oldDataWidth!==null){wpaicgChatShortcode.setAttribute('data-width',oldDataWidth);wpaicgChatShortcode.removeAttribute('data-old-width');}
if(oldDataHeight!==null){wpaicgChatShortcode.setAttribute('data-height',oldDataHeight);wpaicgChatShortcode.removeAttribute('data-old-height');}
wpaicgChatShortcodeSize();}
else{btn.classList.add('wpaicg-fullscreen-box');wpaicgChatShortcode.classList.add('wpaicg-fullscreened');const currentInline=wpaicgChatShortcode.getAttribute('style')||'';wpaicgChatShortcode.setAttribute('data-old-inline-style',currentInline);const currentDataWidth=wpaicgChatShortcode.getAttribute('data-width')||'';const currentDataHeight=wpaicgChatShortcode.getAttribute('data-height')||'';wpaicgChatShortcode.setAttribute('data-old-width',currentDataWidth);wpaicgChatShortcode.setAttribute('data-old-height',currentDataHeight);wpaicgChatShortcode.style.position='fixed';wpaicgChatShortcode.style.top='0';wpaicgChatShortcode.style.left='0';wpaicgChatShortcode.style.zIndex='999999999';wpaicgChatShortcode.style.width='100%';wpaicgChatShortcode.style.height='calc(100vh - 20px)';wpaicgChatShortcode.style.overflowY='auto';wpaicgChatShortcode.setAttribute('data-width','100%');wpaicgChatShortcode.setAttribute('data-height','100%');wpaicgChatShortcodeSize();}}
else{const wpaicgWidgetContent=btn.closest('.wpaicg_chat_widget_content');if(!wpaicgWidgetContent)return;const chatbox=wpaicgWidgetContent.querySelector('.wpaicg-chatbox');if(!chatbox)return;if(isExitingFullscreen){btn.classList.remove('wpaicg-fullscreen-box');wpaicgWidgetContent.classList.remove('wpaicg-fullscreened');if(!isMobile){const oldWidgetStyle=wpaicgWidgetContent.getAttribute('data-old-inline-style')||'';wpaicgWidgetContent.setAttribute('style',oldWidgetStyle);wpaicgWidgetContent.removeAttribute('data-old-inline-style');const oldChatboxStyle=chatbox.getAttribute('data-old-inline-style')||'';chatbox.setAttribute('style',oldChatboxStyle);chatbox.removeAttribute('data-old-inline-style');const oldWidth=chatbox.getAttribute('data-old-width');const oldHeight=chatbox.getAttribute('data-old-height');if(oldWidth!==null){chatbox.setAttribute('data-width',oldWidth);chatbox.removeAttribute('data-old-width');}
if(oldHeight!==null){chatbox.setAttribute('data-height',oldHeight);chatbox.removeAttribute('data-old-height');}}
wpaicgChatBoxSize();}
else{btn.classList.add('wpaicg-fullscreen-box');wpaicgWidgetContent.classList.add('wpaicg-fullscreened');const currentWidgetStyle=wpaicgWidgetContent.getAttribute('style')||'';wpaicgWidgetContent.setAttribute('data-old-inline-style',currentWidgetStyle);const currentChatboxStyle=chatbox.getAttribute('style')||'';chatbox.setAttribute('data-old-inline-style',currentChatboxStyle);const currentDataWidth=chatbox.getAttribute('data-width')||'';const currentDataHeight=chatbox.getAttribute('data-height')||'';chatbox.setAttribute('data-old-width',currentDataWidth);chatbox.setAttribute('data-old-height',currentDataHeight);wpaicgWidgetContent.style.position='fixed';wpaicgWidgetContent.style.top='0';wpaicgWidgetContent.style.left='0';wpaicgWidgetContent.style.width='100%';wpaicgWidgetContent.style.height=isMobile?'100%':'calc(100vh - 20px)';wpaicgWidgetContent.style.zIndex='999999999';wpaicgWidgetContent.style.overflowY='auto';chatbox.style.width='100%';chatbox.style.height=isMobile?'100%':'calc(100vh - 20px)';chatbox.style.overflowY='auto';if(isMobile){chatbox.style.maxWidth='100%';chatbox.style.maxHeight='100%';wpaicgWidgetContent.style.maxWidth='100%';wpaicgWidgetContent.style.maxHeight='100%';btn.style.display='none';}
chatbox.setAttribute('data-width','100%');chatbox.setAttribute('data-height','100%');wpaicgChatBoxSize();}}}
if(wpaicgChatFullScreens.length){for(var i=0;i<wpaicgChatFullScreens.length;i++){var wpaicgChatFullScreen=wpaicgChatFullScreens[i];wpaicgChatFullScreen.addEventListener('click',function(e){wpaicgFullScreen(e.currentTarget);})}}
function resizeChatWidgets(){if(wpaicg_chat_widgets!==null&&wpaicg_chat_widgets.length){for(var i=0;i<wpaicg_chat_widgets.length;i++){var wpaicg_chat_widget=wpaicg_chat_widgets[i];if(window.innerWidth<350){wpaicg_chat_widget.getElementsByClassName('wpaicg-chatbox')[0].style.width=window.innerWidth+'px';wpaicg_chat_widget.getElementsByClassName('wpaicg_chat_widget_content')[0].style.width=window.innerWidth+'px';}}}}
function isMobileDevice(){return window.innerWidth<=767;}
window.addEventListener('resize',function(){wpaicgChatBoxSize();wpaicgChatShortcodeSize();resizeChatWidgets();if(window.innerWidth>767){document.querySelectorAll('.wpaicg-fullscreened .wpaicg-chatbox-fullscreen').forEach(btn=>{btn.style.display='';});}else{document.querySelectorAll('.wpaicg-fullscreened .wpaicg-chatbox-fullscreen').forEach(btn=>{btn.style.display='none';});}
if(isMobileDevice()){const openWidgets=document.querySelectorAll('.wpaicg_widget_open .wpaicg_chat_widget_content');openWidgets.forEach(widget=>{if(!widget.classList.contains('wpaicg-fullscreened')){const fullscreenBtn=widget.querySelector('.wpaicg-chatbox-fullscreen');if(fullscreenBtn){wpaicgFullScreen(fullscreenBtn);fullscreenBtn.style.display='none';}}});}});wpaicgChatShortcodeSize();wpaicgChatBoxSize();resizeChatWidgets();function wpaicgescapeHtml(unsafe){return unsafe.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");}
function wpaicgstartChatRecording(){let constraints={audio:true,video:false}
navigator.mediaDevices.getUserMedia(constraints).then(function(stream){wpaicgaudioContext=new wpaicgChatAudioContext();wpaicgChatStream=stream;wpaicgInput=wpaicgaudioContext.createMediaStreamSource(stream);wpaicgChatRec=new Recorder(wpaicgInput,{numChannels:1});wpaicgChatRec.record();})}
function wpaicgstopChatRecording(mic){wpaicgChatRec.stop();wpaicgChatStream.getAudioTracks()[0].stop();wpaicgChatRec.exportWAV(function(blob){let type=mic.getAttribute('data-type');let parentChat;let chatContent;let chatTyping;if(type==='widget'){parentChat=mic.closest('.wpaicg-chatbox');chatContent=parentChat.querySelectorAll('.wpaicg-chatbox-content')[0];chatTyping=parentChat.querySelectorAll('.wpaicg-chatbox-typing')[0];}else{parentChat=mic.closest('.wpaicg-chat-shortcode');chatContent=parentChat.querySelectorAll('.wpaicg-chat-shortcode-content')[0];chatTyping=parentChat.querySelectorAll('.wpaicg-chat-shortcode-typing')[0];}
wpaicgSendChatMessage(parentChat,chatTyping,type,blob);});}
function generateRandomString(length){let result='';let characters='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';let charactersLength=characters.length;for(let i=0;i<length;i++){result+=characters.charAt(Math.floor(Math.random()*charactersLength));}
return result;}
function setupButtonListeners(isCopyEnabled,isFeedbackEnabled,class_ai_item,emptyClipboardSVG,checkedClipboardSVG,thumbsUpSVG,thumbsDownSVG,showFeedbackModal,aiBg,fontColor,usrBg,chat,wpaicg_nonce,chatbot_identity){let hideTimeout;jQuery(document).on('mouseenter touchstart',`li.${class_ai_item} .wpaicg-icon-container`,function(event){clearTimeout(hideTimeout);if(event.type==='touchstart'){event.stopPropagation();}
const buttons=jQuery(this).find('.wpaicg-copy-button, .wpaicg-thumbs-up-button, .wpaicg-thumbs-down-button');if(isCopyEnabled){buttons.filter('.wpaicg-copy-button').css({display:'inline-block',opacity:1,visibility:'visible'});}
if(isFeedbackEnabled){buttons.filter('.wpaicg-thumbs-up-button, .wpaicg-thumbs-down-button').css({display:'inline-block',opacity:1,visibility:'visible'});}});jQuery(document).on('mouseleave touchend',`li.${class_ai_item} .wpaicg-icon-container`,function(){const buttons=jQuery(this).find('.wpaicg-copy-button, .wpaicg-thumbs-up-button, .wpaicg-thumbs-down-button');hideTimeout=setTimeout(()=>{buttons.css({opacity:0,visibility:'hidden',display:'none'});},2000);});jQuery(document).on('click','.wpaicg-copy-button',function(){const chatId=jQuery(this).data('chat-id');const messageText=document.getElementById(chatId).innerText;navigator.clipboard.writeText(messageText).then(()=>{jQuery(this).html(checkedClipboardSVG);setTimeout(()=>{jQuery(this).html(emptyClipboardSVG);},2000);}).catch(err=>console.error('Failed to copy text: ',err));});jQuery(document).on('click','.wpaicg-thumbs-up-button, .wpaicg-thumbs-down-button',function(){const feedbackType=jQuery(this).hasClass('wpaicg-thumbs-up-button')?'up':'down';const chatId=jQuery(this).data('chat-id').replace('wpaicg-chat-message-','');showFeedbackModal(feedbackType,chatId,aiBg,fontColor,usrBg,chat,wpaicg_nonce,chatbot_identity);});}
function showFeedbackModal(feedbackType,chatId,bgColor,textColor,usrBg,chat,wpaicg_nonce,chatbot_identity){const chatWidget=jQuery('.wpaicg_chat_widget');const feedbackTitle=chat.getAttribute('data-feedback_title')||'Feedback';const feedbackMessage=chat.getAttribute('data-feedback_message')||'Please provide details: (optional)';const feedbackSuccessMessage=chat.getAttribute('data-feedback_success')||'Thank you for your feedback!';const chatShortcode=jQuery(chat).closest('.wpaicg-chat-shortcode');const wasFullscreen=chatShortcode.hasClass('wpaicg-fullscreened');if(wasFullscreen){const fullScreenBtn=chatShortcode.find('.wpaicg-chatbox-fullscreen');wpaicgFullScreen(fullScreenBtn[0]);}
if(chatWidget.hasClass('wpaicg_widget_open')){chatWidget.data('was-open',true);chatWidget.removeClass('wpaicg_widget_open');}else{chatWidget.data('was-open',false);}
const modalHtml=` 
            <style>
                @keyframes wpaicg-feedback-spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
        
                .wpaicg-feedback-spinner {
                    display: inline-block;
                    width: 16px;
                    height: 16px;
                    border: 2px solid ${textColor};
                    border-top: 2px solid ${bgColor};
                    border-radius: 50%;
                    animation: wpaicg-feedback-spin 1s linear infinite;
                }
                .wpaicg-feedback-message {
                    color: ${textColor};
                }
            </style>
            <div class="wpaicg-feedback-modal-overlay">
                <div class="wpaicg-feedback-modal" style="background-color:${bgColor};color:${textColor};position:relative;">
                    <button class="wpaicg-feedback-modal-close" style="position:absolute; top:10px; right:10px; background:none; border:none; color:${textColor}; font-size:18px; cursor:pointer;">&times;</button>
                    <h2 style="background-color:${bgColor};color:${textColor};">${feedbackTitle}</h2>
                    <p>${feedbackMessage}</p>
                    <textarea class="wpaicg-feedback-textarea"></textarea>
                    <div class="wpaicg-feedback-modal-buttons">
                        <div class="wpaicg-feedback-message" style="display:none;"></div>
                        <button class="wpaicg-feedback-modal-submit" style="background-color:${usrBg};color:${textColor};border:none;" data-feedback-type="${feedbackType}" data-chat-id="${chatId}">
                            Submit
                            <span class="wpaicg-feedback-spinner" style="display:none; margin-left:5px; border: 2px solid ${textColor}; border-top: 2px solid ${bgColor}; border-radius: 50%; width: 16px; height: 16px; animation: wpaicg-feedback-spin 1s linear infinite;"></span>
                        </button>
                    </div>
                </div>
            </div>
        `;jQuery('body').append(modalHtml);jQuery('.wpaicg-feedback-modal-close').on('click',function(){jQuery('.wpaicg-feedback-modal-overlay').fadeOut(300,function(){jQuery(this).remove();if(wasFullscreen){const fullScreenBtn=chatShortcode.find('.wpaicg-chatbox-fullscreen');wpaicgFullScreen(fullScreenBtn[0]);}
if(chatWidget.data('was-open')){chatWidget.addClass('wpaicg_widget_open');}});});jQuery('.wpaicg-feedback-modal-submit').on('click',function(){const modal=jQuery(this).closest('.wpaicg-feedback-modal');const feedbackText=modal.find('.wpaicg-feedback-textarea').val();const feedbackType=jQuery(this).data('feedback-type');const chatId=jQuery(this).data('chat-id');const nonce=wpaicg_nonce;const submitButton=jQuery(this);const spinner=submitButton.find('.wpaicg-feedback-spinner');const feedbackMessageElement=modal.find('.wpaicg-feedback-message');spinner.show();submitButton.prop('disabled',true);jQuery.ajax({url:wpaicgParams.ajax_url,method:'POST',data:{action:'wpaicg_submit_feedback',chatId:chatId,feedbackType:feedbackType,feedbackDetails:feedbackText,_wpnonce:nonce,chatbot_id:chatbot_identity,},success:function(response){feedbackMessageElement.html(`<span style="color:${textColor};">${feedbackSuccessMessage}</span>`).fadeIn(300);setTimeout(()=>{jQuery('.wpaicg-feedback-modal-overlay').fadeOut(300,function(){jQuery(this).remove();if(chatWidget.data('was-open')){chatWidget.addClass('wpaicg_widget_open');}
if(wasFullscreen){const fullScreenBtn=chatShortcode.find('.wpaicg-chatbox-fullscreen');wpaicgFullScreen(fullScreenBtn[0]);}});},2000);},error:function(error){feedbackMessageElement.html(`<span style="color:${textColor};">Error. Please try again later.</span>`).fadeIn(300);setTimeout(()=>{jQuery('.wpaicg-feedback-modal-overlay').fadeOut(300,function(){jQuery(this).remove();if(chatWidget.data('was-open')){chatWidget.addClass('wpaicg_widget_open');}
if(wasFullscreen){const fullScreenBtn=chatShortcode.find('.wpaicg-chatbox-fullscreen');wpaicgFullScreen(fullScreenBtn[0]);}});},2000);},complete:function(){spinner.hide();submitButton.prop('disabled',false);}});});}
function wpaicgSendChatMessage(chat,typing,type,blob){hideConversationStarters();var leadFormMessage=chat.querySelector('.wpaicg-lead-form-message');if(leadFormMessage){leadFormMessage.remove();localStorage.setItem('wpaicg_lead_form_shown','1');}
let botIdAudio=chat.getAttribute('data-bot-id')||'0';let chatTypeAudio=chat.getAttribute('data-type')||'shortcode';let audioKey=`audio_${chatTypeAudio}_${botIdAudio}`;let isAudioEnabledByUser=wpaicgUserAudioEnabled[audioKey];let userVoiceControl=chat.getAttribute('data-user-voice-control');let wpaicg_box_typing=typing;let wpaicg_ai_thinking,wpaicg_messages_box,class_user_item,class_ai_item;let wpaicgMessage='';let wpaicgData=new FormData();let wpaicg_nonce=chat.getAttribute('data-nonce');let wpaicg_bot_id=parseInt(chat.getAttribute('data-bot-id'));let wpaicg_user_bg=chat.getAttribute('data-user-bg-color');let wpaicg_font_size=chat.getAttribute('data-fontsize');let wpaicg_speech=chat.getAttribute('data-speech');let wpaicg_voice=chat.getAttribute('data-voice');let elevenlabs_model=chat.getAttribute('data-elevenlabs-model');if(elevenlabs_model===null||elevenlabs_model===undefined){elevenlabs_model=chat.getAttribute('data-elevenlabs_model');}
let elevenlabs_voice=chat.getAttribute('data-elevenlabs-voice');if(elevenlabs_voice===null||elevenlabs_voice===undefined){elevenlabs_voice=chat.getAttribute('data-elevenlabs_voice');}
let wpaicg_voice_error=chat.getAttribute('data-voice-error');let wpaicg_typewriter_effect=chat.getAttribute('data-typewriter-effect');let wpaicg_typewriter_speed=chat.getAttribute('data-typewriter-speed');let url=chat.getAttribute('data-url');let post_id=chat.getAttribute('data-post-id');let wpaicg_ai_bg=chat.getAttribute('data-ai-bg-color');let wpaicg_font_color=chat.getAttribute('data-color');let voice_service=chat.getAttribute('data-voice_service');let voice_language=chat.getAttribute('data-voice_language');let voice_name=chat.getAttribute('data-voice_name');let voice_device=chat.getAttribute('data-voice_device');let openai_model=chat.getAttribute('data-openai_model');let openai_voice=chat.getAttribute('data-openai_voice');let openai_output_format=chat.getAttribute('data-openai_output_format');let openai_voice_speed=chat.getAttribute('data-openai_voice_speed');let openai_stream_nav=chat.getAttribute('data-openai_stream_nav');let voice_speed=chat.getAttribute('data-voice_speed');let voice_pitch=chat.getAttribute('data-voice_pitch');var chat_pdf=chat.getAttribute('data-pdf');var imageInput=document.getElementById('imageUpload');var imageUrl='';if(imageInput){if(imageInput.files&&imageInput.files[0]){var validImageTypes=['image/png','image/jpeg','image/jpg','image/webp','image/gif'];if(!validImageTypes.includes(imageInput.files[0].type)){alert('Invalid file type. Only PNG, JPEG, WEBP, and non-animated GIF images are allowed.');return;}
wpaicgData.append('image',imageInput.files[0],imageInput.files[0].name);imageUrl=URL.createObjectURL(imageInput.files[0]);}}
if(type==='widget'){wpaicg_ai_thinking=chat.getElementsByClassName('wpaicg-bot-thinking')[0];wpaicg_messages_box=chat.getElementsByClassName('wpaicg-chatbox-messages')[0];class_user_item='wpaicg-chat-user-message';class_ai_item='wpaicg-chat-ai-message';wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;const messages=wpaicg_messages_box.querySelectorAll('li');if(messages.length>0){messages[messages.length-1].scrollIntoView();}}else{wpaicg_ai_thinking=chat.getElementsByClassName('wpaicg-bot-thinking')[0];wpaicg_messages_box=chat.getElementsByClassName('wpaicg-chat-shortcode-messages')[0];class_user_item='wpaicg-user-message';class_ai_item='wpaicg-ai-message';}
wpaicg_ai_thinking.style.display='block';let wpaicg_question=wpaicgescapeHtml(wpaicg_box_typing.value);if(!wpaicg_question.trim()&&blob===undefined){wpaicg_ai_thinking.style.display='none';return;}
wpaicgMessage+='<li class="'+class_user_item+'" style="background-color:'+wpaicg_user_bg+';font-size: '+wpaicg_font_size+'px;color: '+wpaicg_font_color+'">';wpaicgData.append('_wpnonce',wpaicg_nonce);wpaicgData.append('post_id',post_id);if(chat_pdf&&chat_pdf!==null){wpaicgData.append('namespace',chat_pdf);}
wpaicgData.append('url',url);if(type==='widget'){wpaicgData.append('action','wpaicg_chatbox_message');}else{wpaicgData.append('action','wpaicg_chat_shortcode_message');}
if(blob!==undefined){let url=URL.createObjectURL(blob);wpaicgMessage+='<audio src="'+url+'" controls="true"></audio>';wpaicgData.append('audio',blob,'wpaicg-chat-recording.wav');}else if(wpaicg_question!==''){wpaicgData.append('message',wpaicg_question);wpaicgMessage+=wpaicg_question.replace(/\n/g,'<br>');}
wpaicgData.append('bot_id',wpaicg_bot_id);wpaicgMessage+='</li>';if(imageUrl!==''){wpaicgMessage+='<li class="'+class_user_item+'" style="background-color:'+wpaicg_user_bg+';font-size: '+wpaicg_font_size+'px;color: '+wpaicg_font_color+'">';wpaicgMessage+='<div style="max-width: 300px; height: auto; display: flex;">';wpaicgMessage+='<img src="'+imageUrl+'" style="max-width: 100%; height: auto;" onload="this.parentElement.parentElement.parentElement.scrollTop = this.parentElement.parentElement.parentElement.scrollHeight;">';wpaicgMessage+='</div>';wpaicgMessage+='</li>';}
wpaicg_messages_box.innerHTML+=wpaicgMessage;wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;var thumbnailPlaceholder=document.querySelector('.wpaicg-thumbnail-placeholder');if(thumbnailPlaceholder){thumbnailPlaceholder.style.display='none';}
if(imageInput){imageInput.value='';}
let chat_type=chat.getAttribute('data-type');let stream_nav;let chatbot_identity;if(wpaicg_bot_id&&wpaicg_bot_id!=="0"){stream_nav=openai_stream_nav;chatbot_identity='custom_bot_'+wpaicg_bot_id;}else{if(chat_type==="shortcode"){stream_nav=chat.getAttribute('data-openai_stream_nav');chatbot_identity='shortcode';}else if(chat_type==="widget"){stream_nav=chat.getAttribute('data-openai_stream_nav');chatbot_identity='widget';}}
wpaicgData.append('chatbot_identity',chatbot_identity);let clientID=localStorage.getItem('wpaicg_chat_client_id');if(!clientID){clientID=generateRandomString(10);localStorage.setItem('wpaicg_chat_client_id',clientID);}
let botId=chat.getAttribute('data-bot-id')||'0';let assistantEnabled=chat.getAttribute('data-assistant-enabled')==='true';let botIdAttr=botId||'0';let activeConversationKey=`wpaicg_current_conversation_${botIdAttr}_${clientID}`;let conversationKey=localStorage.getItem(activeConversationKey);if(!conversationKey){let basePrefix=botIdAttr!=='0'?`wpaicg_chat_history_custom_bot_${botIdAttr}_${clientID}`:`wpaicg_chat_history_${type}_${clientID}`;let newKey=`${basePrefix}_1`;if(!localStorage.getItem(newKey)){localStorage.setItem(newKey,JSON.stringify([]));}
localStorage.setItem(activeConversationKey,newKey);conversationKey=newKey;}
let storedHistory=localStorage.getItem(conversationKey)||'[]';wpaicgData.append('wpaicg_chat_history',storedHistory);wpaicgData.append('wpaicg_chat_client_id',clientID);let activeThreadKey=`wpaicg_current_thread_${botIdAttr}_${clientID}`;let currentThreadStorageKey=null;if(assistantEnabled){currentThreadStorageKey=localStorage.getItem(activeThreadKey);if(!currentThreadStorageKey){let baseThreadPrefix=botIdAttr!=='0'?`custom_bot_${botIdAttr}_${clientID}`:`${type}_${clientID}`;let foundMaxThreadIndex=0;const threadListObj=JSON.parse(localStorage.getItem('wpaicg_thread_list'))||{};for(let existingKey in threadListObj){if(existingKey.startsWith(baseThreadPrefix)){let suffixMatch=existingKey.match(/_(\d+)$/);if(suffixMatch){let indexNum=parseInt(suffixMatch[1],10);if(indexNum>foundMaxThreadIndex)foundMaxThreadIndex=indexNum;}}}
let defaultThreadIndex=foundMaxThreadIndex+1;currentThreadStorageKey=`${baseThreadPrefix}_${defaultThreadIndex}`;localStorage.setItem(activeThreadKey,currentThreadStorageKey);}
let threadListData=JSON.parse(localStorage.getItem('wpaicg_thread_list'))||{};let existingThreadId=threadListData[currentThreadStorageKey];if(existingThreadId){wpaicgData.append('thread_id',existingThreadId);}}
if(imageInputThumbnail){imageInputThumbnail.style.display='none';}
if(stream_nav==="1"){updateChatHistory(wpaicg_question,'user',wpaicg_randomnum,chat,chatbot_identity,clientID);if(assistantEnabled){handleAssistantStreaming(wpaicgData,wpaicg_messages_box,wpaicg_box_typing,wpaicg_ai_thinking,class_ai_item,chat,chatbot_identity,clientID,wpaicg_nonce);}else{handleStreaming(wpaicgData,wpaicg_messages_box,wpaicg_box_typing,wpaicg_ai_thinking,class_ai_item,chat,chatbot_identity,clientID,wpaicg_nonce);}}
else{updateChatHistory(wpaicg_question,'user',wpaicg_randomnum,chat,chatbot_identity,clientID);var wpaicg_randomnum=Math.floor((Math.random()*100000)+1);const chatId=`wpaicg-chat-message-${wpaicg_randomnum}`;const copyEnabled=chat.getAttribute('data-copy_btn')==="1";const feedbackEnabled=chat.getAttribute('data-feedback_btn')==="1";const fontColor=chat.getAttribute('data-color');const usrBg=chat.getAttribute('data-user-bg-color');const emptyClipboardSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-copy" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
            </svg>`;const checkedClipboardSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-check2" viewBox="0 0 16 16">
            <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
            </svg>`;const thumbsUpSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
            <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
            </svg>`;const thumbsDownSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-hand-thumbs-down" viewBox="0 0 16 16">
            <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856s-.036.586-.113.856c-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a10 10 0 0 1-.443-.05 9.36 9.36 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964zM11.5 1H8c-.51 0-.863.068-1.14.163-.281.097-.506.229-.776.393l-.04.025c-.555.338-1.198.73-2.49.868-.333.035-.554.29-.554.55V7c0 .255.226.543.62.65 1.095.3 1.977.997 2.614 1.709.635.71 1.064 1.475 1.238 1.977.243.7.407 1.768.482 2.85.025.362.36.595.667.518l.262-.065c.16-.04.258-.144.288-.255a8.34 8.34 0 0 0-.145-4.726.5.5 0 0 1 .595-.643h.003l.014.004.058.013a9 9 0 0 0 1.036.157c.663.06 1.457.054 2.11-.163.175-.059.45-.301.57-.651.107-.308.087-.67-.266-1.021L12.793 7l.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581s-.027-.414-.075-.581c-.05-.174-.111-.273-.154-.315l-.353-.354.353-.354c.047-.047.109-.176.005-.488a2.2 2.2 0 0 0-.505-.804l-.353-.354.353-.354c.006-.005.041-.05.041-.17a.9.9 0 0 0-.121-.415C12.4 1.272 12.063 1 11.5 1"/>
            </svg>`;const xhttp=new XMLHttpRequest();wpaicg_box_typing.value='';xhttp.open('POST',wpaicgParams.ajax_url,true);xhttp.send(wpaicgData);xhttp.onreadystatechange=function(oEvent){if(xhttp.readyState===4){var wpaicg_message='';var wpaicg_response_text='';if(xhttp.status===200){var wpaicg_response=this.responseText;if(wpaicg_response!==''){wpaicg_response=JSON.parse(wpaicg_response);wpaicg_ai_thinking.style.display='none'
if(wpaicg_response.status==='success'){if(assistantEnabled&&wpaicg_response.thread_id){let threadList=JSON.parse(localStorage.getItem('wpaicg_thread_list'))||{};threadList[currentThreadStorageKey]=wpaicg_response.thread_id;localStorage.setItem('wpaicg_thread_list',JSON.stringify(threadList));}
wpaicg_response_text=wpaicg_response.data;wpaicg_message=`
                                    <li class="${class_ai_item} wpaicg-icon-container" style="background-color:${wpaicg_ai_bg};font-size:${wpaicg_font_size}px;color:${wpaicg_font_color}">
                                        <p style="width:100%">
                                            <span class="wpaicg-chat-message" id="${chatId}">${wpaicg_response_text}</span>
                                            ${copyEnabled ? `<button class="wpaicg-copy-button"data-chat-id="${chatId}">${emptyClipboardSVG}</button>` : ''}
                                            ${feedbackEnabled ? `<button class="wpaicg-thumbs-up-button"data-chat-id="${chatId}">${thumbsUpSVG}</button><button class="wpaicg-thumbs-down-button"data-chat-id="${chatId}">${thumbsDownSVG}</button>` : ''}
                                        </p>
                                    </li>
                                `;}else{wpaicg_response_text=wpaicg_response.msg;wpaicg_message='<li class="'+class_ai_item+'" style="background-color:'+wpaicg_ai_bg+';font-size: '+wpaicg_font_size+'px;color: '+wpaicg_font_color+'"><p style="width:100%"><span class="wpaicg-chat-message wpaicg-chat-message-error" id="wpaicg-chat-message-'+wpaicg_randomnum+'"></span>';}}}else{wpaicg_message='<li class="'+class_ai_item+'" style="background-color:'+wpaicg_ai_bg+';font-size: '+wpaicg_font_size+'px;color: '+wpaicg_font_color+'"><p style="width:100%"><span class="wpaicg-chat-message wpaicg-chat-message-error" id="wpaicg-chat-message-'+wpaicg_randomnum+'"></span>';wpaicg_response_text='Something went wrong. Please clear your cache and try again.';wpaicg_ai_thinking.style.display='none';}
if(wpaicg_response_text==='null'||wpaicg_response_text===null){wpaicg_response_text='Empty response from api. Check your server logs for more details.';}
setupButtonListeners(copyEnabled,feedbackEnabled,class_ai_item,emptyClipboardSVG,checkedClipboardSVG,thumbsUpSVG,thumbsDownSVG,showFeedbackModal,wpaicg_ai_bg,wpaicg_font_color,usrBg,chat,wpaicg_nonce,chatbot_identity);const simpleChatId=chatId.replace('wpaicg-chat-message-','');updateChatHistory(wpaicg_response_text,'ai',simpleChatId,chat,chatbot_identity,clientID);if(wpaicg_response_text!==''&&wpaicg_message!==''){if(parseInt(wpaicg_speech)==1&&(userVoiceControl=="1"?isAudioEnabledByUser:true)){if(voice_service==='google'){wpaicg_ai_thinking.style.display='block';let speechData=new FormData();speechData.append('nonce',wpaicg_nonce);speechData.append('action','wpaicg_google_speech');speechData.append('language',voice_language);speechData.append('name',voice_name);speechData.append('device',voice_device);speechData.append('speed',voice_speed);speechData.append('pitch',voice_pitch);speechData.append('text',wpaicg_response_text);var speechRequest=new XMLHttpRequest();speechRequest.open("POST",wpaicgParams.ajax_url);speechRequest.onload=function(){var result=speechRequest.responseText;try{result=JSON.parse(result);if(result.status==='success'){var byteCharacters=atob(result.audio);const byteNumbers=new Array(byteCharacters.length);for(let i=0;i<byteCharacters.length;i++){byteNumbers[i]=byteCharacters.charCodeAt(i);}
const byteArray=new Uint8Array(byteNumbers);const blob=new Blob([byteArray],{type:'audio/mp3'});const blobUrl=URL.createObjectURL(blob);wpaicg_message+='<audio style="margin-top:6px;" controls="controls"><source type="audio/mpeg" src="'+blobUrl+'"></audio>';wpaicg_message+='</p></li>';wpaicg_ai_thinking.style.display='none';wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}
else{var errorMessageDetail='Google: '+result.msg;wpaicg_ai_thinking.style.display='none';if(parseInt(wpaicg_voice_error)!==1){wpaicg_message+='<span style="width: 100%;display: block;font-size: 11px;">'+errorMessageDetail+'</span>';}
else if(typeof wpaicg_response!=='undefined'&&typeof wpaicg_response.log!=='undefined'&&wpaicg_response.log!==''){var speechLogMessage=new FormData();speechLogMessage.append('nonce',wpaicg_nonce);speechLogMessage.append('log_id',wpaicg_response.log);speechLogMessage.append('message',errorMessageDetail);speechLogMessage.append('action','wpaicg_speech_error_log');var speechErrorRequest=new XMLHttpRequest();speechErrorRequest.open("POST",wpaicgParams.ajax_url);speechErrorRequest.send(speechLogMessage);}
wpaicg_message+='</p></li>';wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}}
catch(errorSpeech){}}
speechRequest.send(speechData);}
else if(voice_service==='openai'){let speechData=new FormData();speechData.append('action','wpaicg_openai_speech');speechData.append('nonce',wpaicg_nonce);speechData.append('text',wpaicg_response_text);speechData.append('model',openai_model);speechData.append('voice',openai_voice);speechData.append('output_format',openai_output_format);speechData.append('speed',openai_voice_speed);wpaicg_ai_thinking.style.display='block';var speechRequest=new XMLHttpRequest();speechRequest.open("POST",wpaicgParams.ajax_url);speechRequest.responseType="arraybuffer";speechRequest.onload=function(){if(speechRequest.status===200){wpaicg_ai_thinking.style.display='none';const audioData=speechRequest.response;const blobMimeType=getBlobMimeType(openai_output_format);const blob=new Blob([audioData],{type:blobMimeType});const blobUrl=URL.createObjectURL(blob);wpaicg_message+='<audio style="margin-top:6px;" controls="controls"><source type="audio/mpeg" src="'+blobUrl+'"></audio>';wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}else{wpaicg_ai_thinking.style.display='none';console.error('Error generating speech with OpenAI:',speechRequest.statusText);wpaicg_message+='<span style="width: 100%;display: block;font-size: 11px;">Error generating speech with OpenAI</span>';wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}};speechRequest.onerror=function(){wpaicg_ai_thinking.style.display='none';console.error('Network error during speech generation with OpenAI');wpaicg_message+='<span style="width: 100%;display: block;font-size: 11px;">Network error during speech generation</span>';wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);};speechRequest.send(speechData);function getBlobMimeType(format){switch(format){case'opus':return'audio/opus';case'aac':return'audio/aac';case'flac':return'audio/flac';default:return'audio/mpeg';}}}
else{let speechData=new FormData();speechData.append('nonce',wpaicg_nonce);speechData.append('message',wpaicg_response_text);speechData.append('voice',wpaicg_voice);speechData.append('elevenlabs_model',elevenlabs_model);speechData.append('action','wpaicg_text_to_speech');wpaicg_ai_thinking.style.display='block';var speechRequest=new XMLHttpRequest();speechRequest.open("POST",wpaicgParams.ajax_url);speechRequest.responseType="arraybuffer";speechRequest.onload=function(){wpaicg_ai_thinking.style.display='none';var blob=new Blob([speechRequest.response],{type:"audio/mpeg"});var fr=new FileReader();fr.onload=function(){var fileText=this.result;try{var errorMessage=JSON.parse(fileText);var errorMessageDetail='ElevenLabs: '+errorMessage.detail.message;if(parseInt(wpaicg_voice_error)!==1){wpaicg_message+='<span style="width: 100%;display: block;font-size: 11px;">'+errorMessageDetail+'</span>';}else if(typeof wpaicg_response!=='undefined'&&typeof wpaicg_response.log!=='undefined'&&wpaicg_response.log!==''){var speechLogMessage=new FormData();speechLogMessage.append('nonce',wpaicg_nonce);speechLogMessage.append('log_id',wpaicg_response.log);speechLogMessage.append('message',errorMessageDetail);speechLogMessage.append('action','wpaicg_speech_error_log');var speechErrorRequest=new XMLHttpRequest();speechErrorRequest.open("POST",wpaicgParams.ajax_url);speechErrorRequest.send(speechLogMessage);}
wpaicg_message+='</p></li>';wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}catch(errorBlob){var blobUrl=URL.createObjectURL(blob);wpaicg_message+='<audio style="margin-top:6px;" controls="controls"><source type="audio/mpeg" src="'+blobUrl+'"></audio>';wpaicg_message+='</p></li>';wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}}
fr.readAsText(blob);}
speechRequest.send(speechData);}}
else{wpaicg_message+='</p></li>';wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed);}}}}}}
function hideConversationStarters(){const starters=document.querySelectorAll('.wpaicg-conversation-starters');starters.forEach(starter=>{starter.style.display='none';});}
function handleStreaming(wpaicgData,wpaicg_messages_box,wpaicg_box_typing,wpaicg_ai_thinking,class_ai_item,chat,chatbot_identity,clientID,wpaicg_nonce){var leadFormMessage=chat.querySelector('.wpaicg-lead-form-message');if(leadFormMessage){leadFormMessage.remove();localStorage.setItem('wpaicg_lead_form_shown','1');}
const fontSize=chat.getAttribute('data-fontsize');const aiBg=chat.getAttribute('data-ai-bg-color');const fontColor=chat.getAttribute('data-color');const usrBg=chat.getAttribute('data-user-bg-color');const copyEnabled=chat.getAttribute('data-copy_btn')==="1";const feedbackEnabled=chat.getAttribute('data-feedback_btn')==="1";wpaicg_box_typing.value='';const chatId=`wpaicg-chat-message-${Math.floor(Math.random() * 100000) + 1}`;const cleanedChatId=chatId.replace('wpaicg-chat-message-','');wpaicgData.append('chat_id',cleanedChatId);const emptyClipboardSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-copy" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
        </svg>`;const checkedClipboardSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-check2" viewBox="0 0 16 16">
        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
        </svg>`;const thumbsUpSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
        <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
        </svg>`;const thumbsDownSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-hand-thumbs-down" viewBox="0 0 16 16">
        <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856s-.036.586-.113.856c-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a10 10 0 0 1-.443-.05 9.36 9.36 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964zM11.5 1H8c-.51 0-.863.068-1.14.163-.281.097-.506.229-.776.393l-.04.025c-.555.338-1.198.73-2.49.868-.333.035-.554.29-.554.55V7c0 .255.226.543.62.65 1.095.3 1.977.997 2.614 1.709.635.71 1.064 1.475 1.238 1.977.243.7.407 1.768.482 2.85.025.362.36.595.667.518l.262-.065c.16-.04.258-.144.288-.255a8.34 8.34 0 0 0-.145-4.726.5.5 0 0 1 .595-.643h.003l.014.004.058.013a9 9 0 0 0 1.036.157c.663.06 1.457.054 2.11-.163.175-.059.45-.301.57-.651.107-.308.087-.67-.266-1.021L12.793 7l.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581s-.027-.414-.075-.581c-.05-.174-.111-.273-.154-.315l-.353-.354.353-.354c.047-.047.109-.176.005-.488a2.2 2.2 0 0 0-.505-.804l-.353-.354.353-.354c.006-.005.041-.05.041-.17a.9.9 0 0 0-.121-.415C12.4 1.272 12.063 1 11.5 1"/>
        </svg>`;const messageHtml=`
            <li class="${class_ai_item} wpaicg-icon-container" style="background-color:${aiBg};font-size:${fontSize}px;color:${fontColor}">
                <p style="width:100%">
                    <span class="wpaicg-chat-message" id="${chatId}"></span>
                    ${copyEnabled ? `<button class="wpaicg-copy-button"data-chat-id="${chatId}">${emptyClipboardSVG}</button>` : ''}
                    ${feedbackEnabled ? `<button class="wpaicg-thumbs-up-button"data-chat-id="${chatId}">${thumbsUpSVG}</button><button class="wpaicg-thumbs-down-button"data-chat-id="${chatId}">${thumbsDownSVG}</button>` : ''}
                </p>
            </li>
        `;let buffer='';let completeAIResponse='';let dataQueue=[];let isProcessing=false;function processBuffer(){processMarkdown(buffer,true,chatId);}
function typeWriter(text,i,elementId,callback){toggleBlinkingCursor(false);if(i<text.length){const charToAdd=text.charAt(i);if(charToAdd==='<'){const tag=text.slice(i,i+4);if(tag==='<br>'){jQuery(`#${elementId}`).append(tag);i+=4;}else{jQuery(`#${elementId}`).append(charToAdd);i++;}}else{jQuery(`#${elementId}`).append(charToAdd);i++;}
setTimeout(()=>typeWriter(text,i,elementId,callback),1);}else if(callback){callback();scrollToBottom();}}
function scrollToBottom(){wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;}
function processQueue(){if(dataQueue.length&&!isProcessing){isProcessing=true;const nextChunk=dataQueue.shift();typeWriter(nextChunk,0,chatId,()=>{isProcessing=false;processQueue();});}else{toggleBlinkingCursor(false);}}
function toggleBlinkingCursor(isVisible){const cursorElement=jQuery(`#${chatId} .blinking-cursor`);if(isVisible){if(!cursorElement.length){jQuery(`#${chatId}`).append('<span class="blinking-cursor">|</span>');}}else{cursorElement.remove();}}
fetch(wpaicgParams.ajax_url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded',},body:new URLSearchParams(wpaicgData).toString(),}).then(response=>response.body).then(async(reader)=>{const decoder=new TextDecoder();const stream=reader.getReader();toggleBlinkingCursor(true);wpaicg_ai_thinking.style.display='none';wpaicg_messages_box.innerHTML+=messageHtml;let partial='';while(true){const{done,value}=await stream.read();if(done){toggleBlinkingCursor(false);wpaicg_ai_thinking.style.display='none';const simpleChatId=chatId.replace('wpaicg-chat-message-','');updateChatHistory(completeAIResponse,'ai',simpleChatId,chat,chatbot_identity,clientID);break;}
partial+=decoder.decode(value);const lines=partial.split('\n');for(let i=0;i<lines.length-1;i++){let line=lines[i];if(line.trim()===''||!line.startsWith('data: ')){continue;}
line=line.slice(6);if(line==="[DONE]"){toggleBlinkingCursor(false);wpaicg_ai_thinking.style.display='none';scrollToBottom();const simpleChatId=chatId.replace('wpaicg-chat-message-','');updateChatHistory(completeAIResponse,'ai',simpleChatId,chat,chatbot_identity,clientID);if(!localStorage.getItem('wpaicg_lead_form_shown')){maybeShowLeadForm(chat,chatId);scrollToBottom();}
return;}
try{const resultData=JSON.parse(line);if(resultData.tokenLimitReached||resultData.messageFlagged||resultData.pineconeError||resultData.ipBanned||resultData.modflag){document.getElementById(chatId).innerHTML=`<span class="wpaicg-chat-message">${resultData.msg}</span>`;wpaicg_ai_thinking.style.display='none';toggleBlinkingCursor(false);scrollToBottom();return;}
if(resultData.error){dataQueue.push(resultData.error.message);}else{const content=resultData.choices?.[0]?.delta?.content||resultData.choices?.[0]?.text||'';buffer+=content;processBuffer();completeAIResponse+=content;}
processQueue();scrollToBottom();}catch(err){console.error('Error parsing JSON:',err,line);}}
partial=lines[lines.length-1];}
if(partial.trim()!==''){const lines=partial.split('\n');for(let line of lines){if(line.trim()===''||!line.startsWith('data: ')){continue;}
line=line.slice(6);if(line==="[DONE]"){toggleBlinkingCursor(false);return;}
try{const resultData=JSON.parse(line);if(resultData.tokenLimitReached||resultData.messageFlagged||resultData.pineconeError||resultData.ipBanned||resultData.modflag){document.getElementById(chatId).innerHTML=`<span class="wpaicg-chat-message">${resultData.msg}</span>`;wpaicg_ai_thinking.style.display='none';toggleBlinkingCursor(false);scrollToBottom();return;}
if(resultData.error){dataQueue.push(resultData.error.message);}else{const content=resultData.choices?.[0]?.delta?.content||resultData.choices?.[0]?.text||'';buffer+=content;processBuffer();completeAIResponse+=content;}
processQueue();scrollToBottom();}catch(err){console.error('Error parsing JSON after stream end:',err,line);}}}}).catch(error=>{console.log("Fetch failed:",error);toggleBlinkingCursor(false);wpaicg_ai_thinking.style.display='none';});setupButtonListeners(copyEnabled,feedbackEnabled,class_ai_item,emptyClipboardSVG,checkedClipboardSVG,thumbsUpSVG,thumbsDownSVG,showFeedbackModal,aiBg,fontColor,usrBg,chat,wpaicg_nonce,chatbot_identity);}
function handleAssistantStreaming(wpaicgData,wpaicg_messages_box,wpaicg_box_typing,wpaicg_ai_thinking,class_ai_item,chat,chatbot_identity,clientID,wpaicg_nonce){const leadFormMessage=chat.querySelector('.wpaicg-lead-form-message');if(leadFormMessage){leadFormMessage.remove();localStorage.setItem('wpaicg_lead_form_shown','1');}
const fontSize=chat.getAttribute('data-fontsize');const aiBg=chat.getAttribute('data-ai-bg-color');const fontColor=chat.getAttribute('data-color');const usrBg=chat.getAttribute('data-user-bg-color');const copyEnabled=chat.getAttribute('data-copy_btn')==="1";const feedbackEnabled=chat.getAttribute('data-feedback_btn')==="1";wpaicg_box_typing.value='';const chatId=`wpaicg-chat-message-${Math.floor(Math.random() * 100000) + 1}`;const cleanedChatId=chatId.replace('wpaicg-chat-message-','');wpaicgData.append('chat_id',cleanedChatId);const emptyClipboardSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-copy" viewBox="0 0 16 16">
        <path fill-rule="evenodd" d="M4 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1zM2 5a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1v-1h1v1a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h1v1z"/>
        </svg>`;const checkedClipboardSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-check2" viewBox="0 0 16 16">
        <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0"/>
        </svg>`;const thumbsUpSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-hand-thumbs-up" viewBox="0 0 16 16">
        <path d="M8.864.046C7.908-.193 7.02.53 6.956 1.466c-.072 1.051-.23 2.016-.428 2.59-.125.36-.479 1.013-1.04 1.639-.557.623-1.282 1.178-2.131 1.41C2.685 7.288 2 7.87 2 8.72v4.001c0 .845.682 1.464 1.448 1.545 1.07.114 1.564.415 2.068.723l.048.03c.272.165.578.348.97.484.397.136.861.217 1.466.217h3.5c.937 0 1.599-.477 1.934-1.064a1.86 1.86 0 0 0 .254-.912c0-.152-.023-.312-.077-.464.201-.263.38-.578.488-.901.11-.33.172-.762.004-1.149.069-.13.12-.269.159-.403.077-.27.113-.568.113-.857 0-.288-.036-.585-.113-.856a2 2 0 0 0-.138-.362 1.9 1.9 0 0 0 .234-1.734c-.206-.592-.682-1.1-1.2-1.272-.847-.282-1.803-.276-2.516-.211a10 10 0 0 0-.443.05 9.4 9.4 0 0 0-.062-4.509A1.38 1.38 0 0 0 9.125.111zM11.5 14.721H8c-.51 0-.863-.069-1.14-.164-.281-.097-.506-.228-.776-.393l-.04-.024c-.555-.339-1.198-.731-2.49-.868-.333-.036-.554-.29-.554-.55V8.72c0-.254.226-.543.62-.65 1.095-.3 1.977-.996 2.614-1.708.635-.71 1.064-1.475 1.238-1.978.243-.7.407-1.768.482-2.85.025-.362.36-.594.667-.518l.262.066c.16.04.258.143.288.255a8.34 8.34 0 0 1-.145 4.725.5.5 0 0 0 .595.644l.003-.001.014-.003.058-.014a9 9 0 0 1 1.036-.157c.663-.06 1.457-.054 2.11.164.175.058.45.3.57.65.107.308.087.67-.266 1.022l-.353.353.353.354c.043.043.105.141.154.315.048.167.075.37.075.581 0 .212-.027.414-.075.582-.05.174-.111.272-.154.315l-.353.353.353.354c.047.047.109.177.005.488a2.2 2.2 0 0 1-.505.805l-.353.353.353.354c.006.005.041.05.041.17a.9.9 0 0 1-.121.416c-.165.288-.503.56-1.066.56z"/>
        </svg>`;const thumbsDownSVG=`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="${fontColor}" class="bi bi-hand-thumbs-down" viewBox="0 0 16 16">
        <path d="M8.864 15.674c-.956.24-1.843-.484-1.908-1.42-.072-1.05-.23-2.015-.428-2.59-.125-.36-.479-1.012-1.04-1.638-.557-.624-1.282-1.179-2.131-1.41C2.685 8.432 2 7.85 2 7V3c0-.845.682-1.464 1.448-1.546 1.07-.113 1.564-.415 2.068-.723l.048-.029c.272-.166.578-.349.97-.484C6.931.08 7.395 0 8 0h3.5c.937 0 1.599.478 1.934 1.064.164.287.254.607.254.913 0 .152-.023.312-.077.464.201.262.38.577.488.9.11.33.172.762.004 1.15.069.13.12.268.159.403.077.27.113.567.113.856s-.036.586-.113.856c-.035.12-.08.244-.138.363.394.571.418 1.2.234 1.733-.206.592-.682 1.1-1.2 1.272-.847.283-1.803.276-2.516.211a10 10 0 0 1-.443-.05 9.36 9.36 0 0 1-.062 4.51c-.138.508-.55.848-1.012.964zM11.5 1H8c-.51 0-.863.068-1.14.163-.281.097-.506.229-.776.393l-.04.025c-.555.338-1.198.73-2.49.868-.333.035-.554.29-.554.55V7c0 .255.226.543.62.65 1.095.3 1.977.997 2.614 1.709.635.71 1.064 1.475 1.238 1.977.243.7.407 1.768.482 2.85.025.362.36.595.667.518l.262-.065c.16-.04.258-.144.288-.255a8.34 8.34 0 0 0-.145-4.726.5.5 0 0 1 .595-.643h.003l.014.004.058.013a9 9 0 0 0 1.036.157c.663.06 1.457.054 2.11-.163.175-.059.45-.301.57-.651.107-.308.087-.67-.266-1.021L12.793 7l.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581s-.027-.414-.075-.581c-.05-.174-.111-.273-.154-.315l-.353-.354.353-.354c.047-.047.109-.176.005-.488a2.2 2.2 0 0 0-.505-.804l-.353-.354.353-.354c.006-.005.041-.05.041-.17a.9.9 0 0 0-.121-.415C12.4 1.272 12.063 1 11.5 1"/>
        </svg>`;const messageHtml=`
            <li class="${class_ai_item} wpaicg-icon-container" style="background-color:${aiBg};font-size:${fontSize}px;color:${fontColor}">
                <span class="wpaicg-chat-message" id="${chatId}"></span>
                ${copyEnabled ? `<button class="wpaicg-copy-button"data-chat-id="${chatId}">${emptyClipboardSVG}</button>` : ''}
                ${feedbackEnabled ? `<button class="wpaicg-thumbs-up-button"data-chat-id="${chatId}">${thumbsUpSVG}</button><button class="wpaicg-thumbs-down-button"data-chat-id="${chatId}">${thumbsDownSVG}</button>` : ''}
            </li>
        `;let completeAIResponse='';let aiMessageAdded=false;let accumulatedBuffer='';let doneCalled=false;const botId=chat.getAttribute('data-bot-id')||'0';const activeThreadKey=`wpaicg_current_thread_${botId}_${clientID}`;const existingThreadKey=localStorage.getItem(activeThreadKey);function scrollToBottom(){wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;}
function toggleBlinkingCursor(isVisible){const cursorElement=jQuery(`#${chatId} .blinking-cursor`);if(isVisible){if(!cursorElement.length){jQuery(`#${chatId}`).append('<span class="blinking-cursor">|</span>');}}else{cursorElement.remove();}}
fetch(wpaicgParams.ajax_url,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded',},body:new URLSearchParams(wpaicgData).toString(),}).then(response=>{const reader=response.body.getReader();const decoder=new TextDecoder();let partial='';let currentEvent=null;function read(){return reader.read().then(({done,value})=>{if(done){handleDoneEvent();return;}
partial+=decoder.decode(value,{stream:true});try{const json=JSON.parse(partial);if(json.status==='error'&&json.msg){handleErrorEvent(json.msg);return;}}catch(e){}
const lines=partial.split('\n');for(let i=0;i<lines.length-1;i++){const line=lines[i].trim();if(line==='')continue;if(line.startsWith('event: ')){currentEvent=line.slice(7).trim();}else if(line.startsWith('data: ')){const data=line.slice(6).trim();handleAssistantStreamEvent(currentEvent,data);}}
partial=lines[lines.length-1];return read();});}
return read();}).catch(error=>{console.log("Fetch failed:",error);toggleBlinkingCursor(false);wpaicg_ai_thinking.style.display='none';});function handleAssistantStreamEvent(event,data){switch(event){case'thread_id':handleThreadIdEvent(data);break;case'thread.message.delta':handleMessageDeltaEvent(data);break;case'thread.message.completed':handleMessageCompletedEvent(data);break;case'assistant_error':handleErrorEvent(data);break;case'done':handleDoneEvent();break;case null:handleErrorEvent(data);break;}}
function handleMessageDeltaEvent(data){const deltaData=JSON.parse(data);if(deltaData&&deltaData.delta&&deltaData.delta.content){const contentArray=deltaData.delta.content;for(const contentItem of contentArray){if(contentItem.type==='text'&&contentItem.text&&contentItem.text.value){const messageChunk=contentItem.text.value;if(!aiMessageAdded){wpaicg_messages_box.innerHTML+=messageHtml;aiMessageAdded=true;wpaicg_ai_thinking.style.display='none';}
accumulatedBuffer+=messageChunk;completeAIResponse+=messageChunk;const htmlContent=marked.parse(accumulatedBuffer);document.getElementById(chatId).innerHTML=htmlContent;scrollToBottom();}}}}
function handleMessageCompletedEvent(data){toggleBlinkingCursor(false);wpaicg_ai_thinking.style.display='none';scrollToBottom();}
function handleThreadIdEvent(threadId){if(existingThreadKey){let threadListObj=JSON.parse(localStorage.getItem('wpaicg_thread_list'))||{};threadListObj[existingThreadKey]=threadId;localStorage.setItem('wpaicg_thread_list',JSON.stringify(threadListObj));}}
function handleErrorEvent(errorData){console.log('Assistant Error:',errorData);let errorMessage='An unknown error occurred.';try{if(typeof errorData==='string'){try{const parsedError=JSON.parse(errorData);errorMessage=parsedError.msg||errorMessage;}catch(jsonParseError){errorMessage=errorData;}}else if(errorData&&errorData.msg){errorMessage=errorData.msg;}}catch(e){console.error('Error handling error data:',e);}
const parsedHtml=marked.parse(errorMessage);const chatElement=document.getElementById(chatId);if(chatElement){chatElement.innerHTML=`<span class="wpaicg-chat-message">${parsedHtml}</span>`;}else{wpaicg_messages_box.innerHTML+=`
                    <li class="${class_ai_item}" style="background-color:${aiBg};font-size:${fontSize}px;color:${fontColor}">
                        <span class="wpaicg-chat-message">${parsedHtml}</span>
                    </li>`;}
wpaicg_ai_thinking.style.display='none';toggleBlinkingCursor(false);scrollToBottom();}
function handleDoneEvent(){if(doneCalled)return;doneCalled=true;toggleBlinkingCursor(false);wpaicg_ai_thinking.style.display='none';if(!localStorage.getItem('wpaicg_lead_form_shown')){maybeShowLeadForm(chat,chatId);scrollToBottom();}
const simpleChatId=chatId.replace('wpaicg-chat-message-','');updateChatHistory(completeAIResponse,'ai',simpleChatId,chat,chatbot_identity,clientID);}
setupButtonListeners(copyEnabled,feedbackEnabled,class_ai_item,emptyClipboardSVG,checkedClipboardSVG,thumbsUpSVG,thumbsDownSVG,showFeedbackModal,aiBg,fontColor,usrBg,chat,wpaicg_nonce,chatbot_identity);}
function processMarkdown(inputText,isStream=false,chatId=null){inputText=inputText!==''?inputText.trim():'';const formattedText=marked.parse(inputText);if(isStream&&chatId){const element=document.getElementById(chatId);if(element){element.innerHTML=formattedText;}}
return formattedText;}
function scrollToAdjust(wpaicg_messages_box){requestAnimationFrame(()=>{wpaicg_messages_box.scrollTop=wpaicg_messages_box.scrollHeight;});}
function wpaicgWriteMessage(wpaicg_messages_box,wpaicg_message,wpaicg_randomnum,wpaicg_response_text,wpaicg_typewriter_effect,wpaicg_typewriter_speed){var chatContainerforLead=wpaicg_messages_box.closest('.wpaicg-chat-shortcode')||wpaicg_messages_box.closest('.wpaicg-chatbox');wpaicg_messages_box.insertAdjacentHTML('beforeend',wpaicg_message);var wpaicg_current_message=document.getElementById('wpaicg-chat-message-'+wpaicg_randomnum);if(wpaicg_current_message){var nextElement=wpaicg_current_message.closest('li').nextElementSibling;if(nextElement&&nextElement.tagName.toLowerCase()==='audio'){nextElement.play();}else{console.log('No audio found next to the current message.');}}else{console.log('Current message not found.');}
var formattedText=marked.parse(wpaicg_response_text);if(wpaicg_typewriter_effect){let index=0;function typeWriter(){if(index<formattedText.length){wpaicg_current_message.innerHTML=formattedText.slice(0,index+1);index++;setTimeout(typeWriter,wpaicg_typewriter_speed);scrollToAdjust(wpaicg_messages_box);}else{scrollToAdjust(wpaicg_messages_box);}}
typeWriter();}else{wpaicg_current_message.innerHTML=formattedText;scrollToAdjust(wpaicg_messages_box);}
if(!localStorage.getItem('wpaicg_lead_form_shown')){maybeShowLeadForm(chatContainerforLead,'wpaicg-chat-message-'+wpaicg_randomnum);scrollToAdjust(wpaicg_messages_box);}}
function wpaicgMicEvent(mic){if(mic.classList.contains('wpaicg-recording')){mic.innerHTML='';mic.innerHTML=wpaicgMicIcon;mic.classList.remove('wpaicg-recording');wpaicgstopChatRecording(mic)}else{let checkRecording=document.querySelectorAll('.wpaicg-recording');if(checkRecording&&checkRecording.length){alert('Please finish previous recording');}else{mic.innerHTML='';mic.innerHTML=wpaicgStopIcon;mic.classList.add('wpaicg-recording');wpaicgstartChatRecording();}}}
if(wpaicgChatTyping&&wpaicgChatTyping.length){for(let i=0;i<wpaicgChatTyping.length;i++){wpaicgChatTyping[i].addEventListener('keyup',function(event){if((event.which===13||event.keyCode===13)&&!event.shiftKey){let parentChat=wpaicgChatTyping[i].closest('.wpaicg-chatbox');let chatTyping=parentChat.querySelectorAll('.wpaicg-chatbox-typing')[0];wpaicgSendChatMessage(parentChat,chatTyping,'widget');}})}}
if(wpaicgShortcodeTyping&&wpaicgShortcodeTyping.length){for(let i=0;i<wpaicgShortcodeTyping.length;i++){wpaicgShortcodeTyping[i].addEventListener('keyup',function(event){if((event.which===13||event.keyCode===13)&&!event.shiftKey){let parentChat=wpaicgShortcodeTyping[i].closest('.wpaicg-chat-shortcode');let chatTyping=parentChat.querySelectorAll('.wpaicg-chat-shortcode-typing')[0];wpaicgSendChatMessage(parentChat,chatTyping,'shortcode');}})}}
if(wpaicgChatSend&&wpaicgChatSend.length){for(let i=0;i<wpaicgChatSend.length;i++){wpaicgChatSend[i].addEventListener('click',function(event){let parentChat=wpaicgChatSend[i].closest('.wpaicg-chatbox');let chatTyping=parentChat.querySelectorAll('.wpaicg-chatbox-typing')[0];wpaicgSendChatMessage(parentChat,chatTyping,'widget');})}}
if(wpaicgShortcodeSend&&wpaicgShortcodeSend.length){for(let i=0;i<wpaicgShortcodeSend.length;i++){wpaicgShortcodeSend[i].addEventListener('click',function(event){let parentChat=wpaicgShortcodeSend[i].closest('.wpaicg-chat-shortcode');let chatTyping=parentChat.querySelectorAll('.wpaicg-chat-shortcode-typing')[0];wpaicgSendChatMessage(parentChat,chatTyping,'shortcode');})}}
if(wpaicgMicBtns&&wpaicgMicBtns.length){for(let i=0;i<wpaicgMicBtns.length;i++){wpaicgMicBtns[i].addEventListener('click',function(){wpaicgMicEvent(wpaicgMicBtns[i]);});}}}
function initSidebarToggle(){const toggleButtons=document.querySelectorAll('.wpaicg-sidebar-toggle');const savedSidebarState=localStorage.getItem('wpaicg_sidebar_state')||'closed';document.querySelectorAll('.wpaicg-sidebar').forEach(sidebar=>{if(savedSidebarState==='open'){sidebar.classList.add('open');}else{sidebar.classList.remove('open');}});toggleButtons.forEach(toggle=>{toggle.addEventListener('click',function(){const chatContainer=this.closest('.wpaicg-chat-shortcode, .wpaicg-chatbox');const sidebar=chatContainer.querySelector('.wpaicg-sidebar');sidebar.classList.toggle('open');const newState=sidebar.classList.contains('open')?'open':'closed';localStorage.setItem('wpaicg_sidebar_state',newState);});toggle.addEventListener('keypress',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();this.click();}});});}
function loadConversationList(){const containers=['.wpaicg-chat-shortcode','.wpaicg-chatbox'];containers.forEach(containerSelector=>{const chatContainers=document.querySelectorAll(containerSelector);chatContainers.forEach(chatContainer=>{const sidebar=chatContainer.querySelector('.wpaicg-sidebar');if(!sidebar)return;const conversationList=sidebar.querySelector('.wpaicg-conversation-list');if(!conversationList)return;conversationList.innerHTML='';const botId=chatContainer.getAttribute('data-bot-id')||'0';const chatType=chatContainer.getAttribute('data-type')||'shortcode';let clientID=localStorage.getItem('wpaicg_chat_client_id');if(!clientID)return;let conversationKeyBase='';if(botId!=='0'){conversationKeyBase=`wpaicg_chat_history_custom_bot_${botId}_${clientID}`;}else{conversationKeyBase=`wpaicg_chat_history_${chatType}_${clientID}`;}
let conversationData=[];for(let i=0;i<localStorage.length;i++){const key=localStorage.key(i);if(key.startsWith(conversationKeyBase+'_')){if(key.endsWith('_timestamp'))continue;const rawData=localStorage.getItem(key);if(!rawData)continue;let chatHistory;try{chatHistory=JSON.parse(rawData);}catch(e){chatHistory=[];}
let title="Untitled Conversation";if(Array.isArray(chatHistory)&&chatHistory.length>0){for(let j=0;j<chatHistory.length;j++){let msg=chatHistory[j].text;if(typeof msg==='string'&&msg.startsWith('Human:')){const userMsg=msg.replace(/^Human:\s*/,'').trim();title=userMsg.substring(0,20)+(userMsg.length>20?'…':'');break;}}}
const timestampKey=key+'_timestamp';const rawTimestamp=localStorage.getItem(timestampKey);const lastUpdated=rawTimestamp?parseInt(rawTimestamp,10):0;conversationData.push({key,lastUpdated,title});}}
conversationData.sort((a,b)=>b.lastUpdated-a.lastUpdated);conversationData.forEach(item=>{const li=document.createElement('li');li.textContent=item.title;li.dataset.conversationKey=item.key;const trashIcon=document.createElement('span');trashIcon.classList.add('dashicons','dashicons-trash','wpaicg-delete-icon');trashIcon.addEventListener('click',e=>{e.stopPropagation();localStorage.removeItem(item.key);localStorage.removeItem(item.key+'_timestamp');li.remove();});li.appendChild(trashIcon);li.addEventListener('click',function(){loadSelectedConversation(item.key,chatContainer);});conversationList.appendChild(li);});});});}
function loadSelectedConversation(conversationKey,chatContainer){var chatBox=chatContainer.querySelector('.wpaicg-chatbox-messages, .wpaicg-chat-shortcode-messages');if(!chatBox)return;chatBox.innerHTML='';var rawHistory=localStorage.getItem(conversationKey);if(!rawHistory)return;var chatHistory=JSON.parse(rawHistory);if(!Array.isArray(chatHistory))chatHistory=[];chatHistory.forEach(message=>{reconstructMessage(chatBox,message,chatContainer);});chatBox.scrollTop=chatBox.scrollHeight;const botId=chatContainer.getAttribute('data-bot-id')||'0';const clientID=localStorage.getItem('wpaicg_chat_client_id')||'';const activeConversationKey=`wpaicg_current_conversation_${botId}_${clientID}`;localStorage.setItem(activeConversationKey,conversationKey);let assistantEnabled=chatContainer.getAttribute('data-assistant-enabled')==='true';if(assistantEnabled){let suffixParts=conversationKey.split('_');if(suffixParts.length>=2){let lastIndex=suffixParts[suffixParts.length-1];let conversationKeyBase=suffixParts.slice(3).join('_');let activeThreadKeyName=`wpaicg_current_thread_${botId}_${clientID}`;localStorage.setItem(activeThreadKeyName,conversationKeyBase);}}}
document.addEventListener('DOMContentLoaded',function(){wpaicgChatInit();loadConversations();initSidebarToggle();loadConversationList();initNewChatButtons();});